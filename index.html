<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบ E-Donation วัดไชยามาตย์</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Tailwind Config สำหรับปรับแต่งฟอนต์และสี -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Sarabun', 'sans-serif'],
            heading: ['Prompt', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#f5f3ff',
              100: '#ede9fe',
              200: '#ddd6fe',
              300: '#c4b5fd',
              400: '#a78bfa',
              500: '#8b5cf6',
              600: '#7c3aed',
              700: '#6d28d9',
              800: '#433385', /* สีรองจากโลโก้ */
              900: '#2e377d', /* สีหลักจากโลโก้ */
            }
          }
        }
      }
    }
  </script>

  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { 
      background-color: #f8fafc;
      color: #334155;
    }
    .animate-fade-in { 
      animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
    }
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- โหลด Firebase SDK แบบ Module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ส่งออกไปยัง window object เพื่อให้โค้ดฝั่ง React นำไปใช้งานได้
    window.firebaseModules = {
      initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc
    };
  </script>

  <!-- เขียนแอปพลิเคชัน React -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ================= SVG Icons (จำลองจาก lucide-react) =================
    const Icon = ({ paths, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {paths}
      </svg>
    );

    const Download = (p) => <Icon {...p} paths={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />;
    const Search = (p) => <Icon {...p} paths={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />;
    const FileText = (p) => <Icon {...p} paths={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />;
    const CheckCircle2 = (p) => <Icon {...p} paths={<><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></>} />;
    const CheckCircle = CheckCircle2;
    const AlertCircle = (p) => <Icon {...p} paths={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />;
    const Trash2 = (p) => <Icon {...p} paths={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />;
    const SearchCode = (p) => <Icon {...p} paths={<><path d="m13 13.5 2-2.5-2-2.5"/><path d="m21 21-4.3-4.3"/><path d="M9 8.5 7 11l2 2.5"/><circle cx="11" cy="11" r="8"/></>} />;
    const UploadCloud = (p) => <Icon {...p} paths={<><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="16 16 12 12 8 16"/></>} />;
    const BarChart3 = (p) => <Icon {...p} paths={<><path d="M3 3v18h18"/><rect width="4" height="7" x="7" y="10" rx="1"/><rect width="4" height="12" x="15" y="5" rx="1"/></>} />;
    const UserPlus = (p) => <Icon {...p} paths={<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>} />;
    const Users = (p) => <Icon {...p} paths={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
    const Menu = (p) => <Icon {...p} paths={<><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></>} />;
    const X = (p) => <Icon {...p} paths={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />;
    const PieChart = (p) => <Icon {...p} paths={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>} />;
    const LogOut = (p) => <Icon {...p} paths={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>} />;
    const User = (p) => <Icon {...p} paths={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
    const Clock = (p) => <Icon {...p} paths={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
    const Info = (p) => <Icon {...p} paths={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>} />;
    const ShieldCheck = (p) => <Icon {...p} paths={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></>} />;

    // ฟังก์ชันเริ่มการทำงานของแอป
    const startApp = () => {
      // ตรวจสอบว่า Firebase โหลดเสร็จหรือยัง (ป้องกัน Race Condition)
      if (!window.firebaseModules) {
        setTimeout(startApp, 50); // ถ้ายังไม่เสร็จให้รอ 50ms แล้วเช็คใหม่
        return;
      }

      const { 
        initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
        getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc
      } = window.firebaseModules;

      // ================= Firebase Setup =================
      const firebaseConfig = {
        apiKey: "AIzaSyDWY0la-lGPQEsEB0NNwhXWenoPJDjtwNk",
        authDomain: "e-donation-e-tax.firebaseapp.com",
        projectId: "e-donation-e-tax",
        storageBucket: "e-donation-e-tax.firebasestorage.app",
        messagingSenderId: "933266533512",
        appId: "1:933266533512:web:0502c4a72d1df16d1bc33d",
        measurementId: "G-TTNTG4SG0V"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ใช้ APP_ID เพื่อแยกพื้นที่เก็บข้อมูล
      const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'edonation-chaiyamat';

      function App() {
        const [approveInputId, setApproveInputId] = useState(null);
        const [receiptNoInput, setReceiptNoInput] = useState('');

        // ================= State สำหรับระบบ Auth และ Firebase =================
        const [firebaseUser, setFirebaseUser] = useState(null);
        const [isDbReady, setIsDbReady] = useState(false);
        const [currentUser, setCurrentUser] = useState(null); // null = ยังไม่ล็อกอินเข้าสู่ระบบวัด
        const [authMode, setAuthMode] = useState('login'); // 'login' | 'register'
        
        // State สำหรับจัดการหน้าจอและเมนู
        const [activeMenu, setActiveMenu] = useState('');
        const [isSidebarOpen, setIsSidebarOpen] = useState(true);
        const [notification, setNotification] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        
        // State สำหรับเพิ่มผู้ใช้งานใหม่
        const [showAddUserForm, setShowAddUserForm] = useState(false);
        const [newUserForm, setNewUserForm] = useState({ name: '', username: '', password: '', role: 'admin', taxId: '' });

        // ================= ข้อมูลจากฐานข้อมูล Firebase =================
        const [users, setUsers] = useState([]);
        const [donations, setDonations] = useState([]);

        // ================= 초기化 Firebase & Fetch Data =================
        useEffect(() => {
          // 1. ตรวจสอบสิทธิ์ Firebase โดยใช้ Token ของระบบ (ถ้ามี) หรือ Anonymous Auth
          const initAuth = async () => {
            try {
              if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                  // ระบบจะพยายามล็อกอินด้วย Token ของระบบก่อน
                  await signInWithCustomToken(auth, __initial_auth_token);
                } catch (tokenError) {
                  // หากเกิด Custom Token Mismatch (เพราะเชื่อมต่อ Firebase ส่วนตัว) ให้สลับมาใช้ Anonymous
                  console.warn("ใช้ Firebase ส่วนตัว: สลับเป็น Anonymous Auth");
                  await signInAnonymously(auth);
                }
              } else {
                await signInAnonymously(auth);
              }
            } catch (error) {
              console.error("Firebase Auth Error:", error);
            }
          };
          initAuth();

          const unsubscribeAuth = onAuthStateChanged(auth, user => {
            setFirebaseUser(user);
          });

          return () => unsubscribeAuth();
        }, []);

        useEffect(() => {
          if (!firebaseUser) return;

          // 2. ดึงข้อมูลแบบ Real-time จาก Firestore
          const donationsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'donations');
          const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');

          const unsubDonations = onSnapshot(donationsRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // เรียงจากใหม่ไปเก่า
            data.sort((a, b) => b.createdAt - a.createdAt);
            setDonations(data);
          }, (error) => console.error(error));

          const unsubUsers = onSnapshot(usersRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Seed ข้อมูลเบื้องต้นหากฐานข้อมูลว่างเปล่า
            if (data.length === 0) {
              addDoc(usersRef, { username: 'admin', password: 'password', name: 'เจ้าหน้าที่ วัดไชยามาตย์', role: 'admin', taxId: '' });
              addDoc(usersRef, { username: 'jaidee', password: 'password', name: 'นาย ใจดี มีบุญ', role: 'donor', taxId: '1101400012345' });
            } else {
              setUsers(data);
              setIsDbReady(true);
            }
          }, (error) => console.error(error));

          return () => {
            unsubDonations();
            unsubUsers();
          };
        }, [firebaseUser]);

        const initialFormState = {
          date: new Date().toISOString().split('T')[0], isAnonymous: false, donorType: 'individual',
          taxId: '', prefix: '', firstName: '', lastName: '', corpName: '', cashAmount: '', assetName: '', assetValue: '', note: ''
        };
        const [formData, setFormData] = useState(initialFormState);
        const [authForm, setAuthForm] = useState({ username: '', password: '', name: '', taxId: '' });

        // ================= ฟังก์ชันช่วยเหลือ =================
        const showNotification = (message, type = 'success') => {
          setNotification({ message, type });
          setTimeout(() => setNotification(null), 3000);
        };

        const handleInputChange = (e) => {
          const { name, value, type, checked } = e.target;
          setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
        };

        const handleAuthChange = (e) => {
          setAuthForm({ ...authForm, [e.target.name]: e.target.value });
        };

        const handleVerifyTaxId = () => {
          if (formData.taxId.length === 13) {
            const foundDonation = donations.find(d => d.taxId === formData.taxId);
            const foundUser = users.find(u => u.taxId === formData.taxId);

            if (foundDonation) {
              setFormData(prev => ({
                ...prev,
                donorType: foundDonation.donorType || 'individual',
                prefix: foundDonation.prefix || '',
                firstName: foundDonation.firstName || '',
                lastName: foundDonation.lastName || '',
                corpName: foundDonation.corpName || ''
              }));
              showNotification('พบข้อมูลในระบบ ทำการดึงข้อมูลเรียบร้อย', 'success');
            } else if (foundUser) {
              const nameParts = foundUser.name.split(' ');
              setFormData(prev => ({
                ...prev,
                donorType: 'individual',
                firstName: nameParts[0] || '',
                lastName: nameParts.slice(1).join(' ') || ''
              }));
              showNotification('พบประวัติผู้ใช้งาน ทำการดึงข้อมูลเรียบร้อย', 'success');
            } else {
              showNotification('ไม่พบข้อมูลในระบบ สามารถกรอกข้อมูลใหม่ได้เลย', 'success');
            }
          } else {
            showNotification('กรุณากรอกเลขประจำตัว 13 หลัก', 'error');
          }
        };

        // ฟังก์ชันเข้าสู่ระบบ
        const handleLogin = (e) => {
          e.preventDefault();
          if(!isDbReady) {
            showNotification('กำลังเชื่อมต่อฐานข้อมูล กรุณารอสักครู่', 'error');
            return;
          }
          const user = users.find(u => u.username === authForm.username && u.password === authForm.password);
          if (user) {
            setCurrentUser(user);
            setActiveMenu(user.role === 'admin' ? 'list' : 'instructions');
            showNotification(`ยินดีต้อนรับคุณ ${user.name}`);
            setAuthForm({ username: '', password: '', name: '', taxId: '' });
          } else {
            showNotification('ชื่อผู้ใช้งานหรือรหัสผ่านไม่ถูกต้อง', 'error');
          }
        };

        // ฟังก์ชันสมัครสมาชิก
        const handleRegister = async (e) => {
          e.preventDefault();
          if (users.find(u => u.username === authForm.username)) {
            showNotification('ชื่อผู้ใช้งานนี้มีในระบบแล้ว', 'error'); return;
          }
          if (authForm.taxId.length !== 13) {
            showNotification('กรุณากรอกเลขประจำตัว 13 หลัก', 'error'); return;
          }
          const newUser = {
            username: authForm.username,
            password: authForm.password,
            name: authForm.name,
            role: 'donor',
            taxId: authForm.taxId,
            createdAt: Date.now()
          };
          
          // บันทึกลง Firebase
          try {
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), newUser);
            setAuthMode('login');
            showNotification('สมัครสมาชิกสำเร็จ กรุณาเข้าสู่ระบบ');
          } catch (err) {
            showNotification('เกิดข้อผิดพลาดในการสมัครสมาชิก', 'error');
          }
        };

        const handleLogout = () => {
          setCurrentUser(null);
          setActiveMenu('');
        };

        // บันทึกการบริจาค (รองรับทั้ง Admin และ Donor) -> อัปเดตขึ้น Firebase
        const handleSubmitDonation = async (e) => {
          e.preventDefault();
          
          const actualTaxId = currentUser.role === 'donor' ? currentUser.taxId : formData.taxId;
          const actualFirstName = currentUser.role === 'donor' ? currentUser.name.split(' ')[0] : formData.firstName;
          const actualLastName = currentUser.role === 'donor' ? currentUser.name.split(' ').slice(1).join(' ') : formData.lastName;

          if (!formData.isAnonymous && actualTaxId.length !== 13) {
            showNotification('กรุณากรอกเลขประจำตัว 13 หลักให้ถูกต้อง', 'error'); return;
          }
          const cash = parseFloat(formData.cashAmount) || 0;
          const asset = parseFloat(formData.assetValue) || 0;
          if (cash <= 0 && asset <= 0) {
            showNotification('ต้องระบุจำนวนเงินสดหรือมูลค่าทรัพย์สินอย่างน้อย 1 รายการ', 'error'); return;
          }

          const status = currentUser.role === 'admin' ? 'approved' : 'pending';

          const newDonation = { 
            ...formData, 
            taxId: actualTaxId,
            firstName: actualFirstName,
            lastName: actualLastName,
            cashAmount: cash, 
            assetValue: asset, 
            status,
            createdAt: Date.now()
          };
          
          try {
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'donations'), newDonation);
            setFormData(initialFormState);
            
            if (currentUser.role === 'admin') {
              showNotification('บันทึกข้อมูลการบริจาคลงระบบสำเร็จ');
              setActiveMenu('list');
            } else {
              showNotification('ส่งรายการแจ้งบริจาคเรียบร้อย รอเจ้าหน้าที่ตรวจสอบ');
              setActiveMenu('donor_history');
            }
          } catch (error) {
            showNotification('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
          }
        };

        const confirmApprove = async (id) => {
          if (!receiptNoInput.trim()) {
            showNotification('กรุณากรอกเลขที่ใบเสร็จให้ครบถ้วน', 'error');
            return;
          }
          
          try {
            const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'donations', id);
            await updateDoc(docRef, { status: 'approved', receiptNo: receiptNoInput.trim() });
            showNotification(`อนุมัติและอัปเดตเลขที่ใบเสร็จ "${receiptNoInput}" สำเร็จ`);
            setApproveInputId(null);
            setReceiptNoInput('');
          } catch (error) {
            showNotification('เกิดข้อผิดพลาดในการอัปเดตข้อมูล', 'error');
          }
        };

        // ฟังก์ชันช่วยเหลือสำหรับฟอร์แมตใบเสร็จ
        const formatThaiDate = (dateString) => {
          if (!dateString) return '';
          const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
          const d = new Date(dateString);
          return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
        };

        const formatDateTimeThai = (date) => {
          const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
          const pad = (n) => n.toString().padStart(2, '0');
          return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
        };

        const formatTaxId = (id) => {
          if (!id || id.length !== 13) return id;
          return `${id[0]} ${id.substring(1, 5)} ${id.substring(5, 10)} ${id.substring(10, 12)} ${id[12]}`;
        };

        const getThaiBahtText = (amount) => {
          const number = Math.round(amount * 100) / 100;
          if (number === 0) return 'ศูนย์บาทถ้วน';
          const t1 = ["", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า"];
          const t2 = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"];
          let numStr = number.toFixed(2).split('.');
          let baht = numStr[0];
          let satang = numStr[1];
          
          let result = "";
          const readPart = (str) => {
            let res = "";
            for (let i = 0; i < str.length; i++) {
              let n = parseInt(str[i]);
              let pos = str.length - i - 1;
              if (n !== 0) {
                if (pos === 0 && n === 1 && str.length > 1 && str[i-1] !== '0') res += "เอ็ด";
                else if (pos === 1 && n === 1) res += "";
                else if (pos === 1 && n === 2) res += "ยี่";
                else res += t1[n];
                res += t2[pos];
              }
            }
            return res;
          };
          
          if (baht !== "0") result += readPart(baht) + "บาท";
          if (satang === "00") result += "ถ้วน";
          else result += readPart(satang) + "สตางค์";
          return result;
        };

        const handleDownloadReceipt = (donation) => {
          const printWindow = window.open('', '_blank');
          
          // เตรียมข้อมูลสำหรับแสดงผล
          const donorName = donation.donorType === 'individual' 
            ? `${donation.prefix || ''}${donation.firstName} ${donation.lastName}`.trim()
            : donation.corpName;
          const totalAmount = (donation.cashAmount || 0) + (donation.assetValue || 0);
          const formattedTaxId = formatTaxId(donation.taxId);
          const printDateTime = formatDateTimeThai(new Date());
          const donationDateThai = formatThaiDate(donation.date);
          const bahtText = getThaiBahtText(totalAmount);
          const receiptNo = donation.receiptNo || '-';

          printWindow.document.write(`
            <html>
              <head>
                <title>ใบเสร็จ e-Donation - ${donorName}</title>
                <style>
                  @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
                  body { font-family: 'Sarabun', sans-serif; padding: 40px; color: #1a1a1a; line-height: 1.5; background-color: #fff; margin: 0; }
                  .receipt-container { max-width: 900px; margin: 0 auto; position: relative; z-index: 1; padding: 20px; }
                  
                  /* Watermark styling */
                  .watermark {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 450px;
                    opacity: 0.08; /* ปรับความจางของลายน้ำที่นี่ */
                    z-index: -1;
                    pointer-events: none;
                  }
                  
                  /* Header & Logos */
                  .header-row-1 { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; }
                  .receipt-title { font-size: 32px; font-weight: 700; color: #2e377d; }
                  
                  /* Sub headers */
                  .header-row-2 { display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 10px; color: #333; align-items: flex-end; }
                  .divider { height: 1.5px; background-color: #d1d5db; margin-bottom: 25px; }
                  
                  /* Main Grid Content */
                  .content-grid { display: grid; grid-template-columns: 200px 1fr; row-gap: 25px; margin-bottom: 60px; }
                  .label { font-size: 20px; font-weight: 700; color: #000; padding-top: 2px; text-align: left; }
                  .details { display: flex; flex-direction: column; }
                  .val-title { font-size: 20px; font-weight: 700; color: #000; }
                  .val-sub { font-size: 16px; font-weight: 400; color: #000; margin-top: 6px; }
                  .val-sub strong { font-weight: 700; }
                  
                  /* Signatures Footer */
                  .signatures { display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; margin-top: 80px; align-items: end; }
                  .sig-left { text-align: left; font-size: 12px; color: #333; }
                  .sig-center { text-align: center; }
                  .sig-name { font-size: 18px; font-weight: 700; color: #000; margin-bottom: 5px; }
                  .sig-role { font-size: 18px; font-weight: 700; color: #000; }
                  .sig-right { text-align: right; }
                  .sig-date-title { font-size: 18px; font-weight: 700; color: #000; margin-bottom: 5px; }
                  .sig-print-date { font-size: 16px; font-weight: 700; color: #000; }
                  
                  /* Notes */
                  .notes { margin-top: 20px; font-size: 12px; color: #333; line-height: 1.6; }
                  .notes-flex { display: flex; }
                  .notes-label { white-space: nowrap; margin-right: 5px; }
                  
                  @media print {
                    body { padding: 0; }
                    .receipt-container { max-width: 100%; padding: 0; }
                    .watermark {
                      -webkit-print-color-adjust: exact;
                      print-color-adjust: exact;
                    }
                  }
                </style>
              </head>
              <body>
                <div class="receipt-container">
                  <!-- ภาพลายน้ำตรงกลาง -->
                  <img src="https://img2.pic.in.th/pic/-Ver.3-1.png" alt="watermark" class="watermark" />
                  
                  <div class="header-row-1">
                    <img src="https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_fovzwgfovzwgfovz.png" alt="โลโก้วัดไชยามาตย์" style="max-height: 80px; object-fit: contain;" />
                    <div class="receipt-title">ใบรับเงินบริจาค</div>
                  </div>
                  <div class="header-row-2">
                    <div>ระบบบริจาคอิเล็กทรอนิกส์ (e-Donation) กรมสรรพากร</div>
                    <div><strong>เลขที่</strong> ${receiptNo}</div>
                  </div>
                  
                  <div class="divider"></div>
                  
                  <div class="content-grid">
                    <div class="label">ผู้บริจาค</div>
                    <div class="details">
                      <div class="val-title">${donorName}</div>
                      <div class="val-sub">เลขประจำตัวประชาชน / เลขประจำตัวผู้เสียภาษีอากร <strong>${formattedTaxId}</strong></div>
                    </div>
                    
                    <div class="label">หน่วยรับบริจาค</div>
                    <div class="details">
                      <div class="val-title">วัดไชยามาตย์</div>
                      <div class="val-sub">ตำบล/แขวง เวียงทอง อำเภอ/เขต สูงเม่น จังหวัด แพร่</div>
                      <div class="val-sub">เลขประจำตัวหน่วยรับบริจาค <strong>0 9940 02406 46 8</strong></div>
                    </div>
                    
                    <div class="label">วันที่บริจาค</div>
                    <div class="details">
                      <div class="val-title">${donationDateThai}</div>
                    </div>
                    
                    <div class="label">จำนวนเงินบริจาค</div>
                    <div class="details">
                      <div class="val-title">${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท</div>
                      <div class="val-sub">( ${bahtText} )</div>
                    </div>
                  </div>
                  
                  <div class="signatures">
                    <div class="sig-left">
                      DN: 12e82105
                    </div>
                    <div class="sig-center">
                      <div class="sig-name">พระครู วิจารณ์ธรรมภิวัฒน์ (อนันต์ เวียงโอสถ)</div>
                      <div class="sig-role">ผู้มีอำนาจลงนาม</div>
                    </div>
                    <div class="sig-right">
                      <div class="sig-date-title">วันเดือนปีที่ขอพิมพ์</div>
                      <div class="sig-print-date">${printDateTime}</div>
                    </div>
                  </div>
                  
                  <div class="notes">
                    <div class="notes-flex">
                      <div class="notes-label">หมายเหตุ : </div>
                      <div>
                        1. ข้อมูลบริจาคของท่านได้บันทึกไว้ในระบบบริจาคอิเล็กทรอนิกส์ (e-Donation) ท่านสามารถตรวจสอบได้ที่เว็บไซต์กรมสรรพากร (www.rd.go.th)<br>
                        2. กรมสรรพากรเป็นเพียงผู้ให้บริการระบบบริจาคอิเล็กทรอนิกส์ (e-Donation) กรณีที่ท่านต้องการแก้ไข หรือยกเลิกหรือสอบถามเกี่ยวกับรายการบริจาค<br>
                        &nbsp;&nbsp;&nbsp;ของท่านสามารถสอบถามได้ที่หน่วยรับบริจาคที่ท่านทำรายการ
                      </div>
                    </div>
                  </div>
                </div>
                <script>
                  // สั่งพิมพ์อัตโนมัติเมื่อหน้าเว็บโหลดเสร็จ
                  window.onload = function() {
                    window.print();
                  }
                <\/script>
              </body>
            </html>
          `);
          printWindow.document.close();
        };

        const handleDelete = async (id) => {
          if(window.confirm('คุณต้องการลบรายการนี้ใช่หรือไม่?')) {
            try {
              const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'donations', id);
              await deleteDoc(docRef);
              showNotification('ลบรายการสำเร็จ');
            } catch (error) {
              showNotification('เกิดข้อผิดพลาดในการลบข้อมูล', 'error');
            }
          }
        }

        const exportToCSV = () => {
          const BOM = '\uFEFF';
          const headers = 'วันที่รับบริจาค,ประเภทผู้บริจาค,เลขประจำตัวผู้เสียภาษีอากร,คำนำหน้าชื่อ,ชื่อ,นามสกุล,ชื่อนิติบุคคล,มูลค่าเงินสด,รายการทรัพย์สิน,มูลค่าทรัพย์สิน\n';
          const approvedDonations = donations.filter(d => d.status === 'approved');
          
          const csvContent = approvedDonations.map(d => {
            const [year, month, day] = d.date.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            const donorTypeText = d.donorType === 'individual' ? 'บุคคลธรรมดา' : 'นิติบุคคล';
            return `"${formattedDate}","${donorTypeText}","${d.taxId}","${d.prefix}","${d.firstName}","${d.lastName}","${d.corpName}","${d.cashAmount || 0}","${d.assetName}","${d.assetValue || 0}"`;
          }).join('\n');

          const blob = new Blob([BOM + headers + csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `e-donation_export_${new Date().toISOString().split('T')[0]}.csv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        const handleAddUserSubmit = async (e) => {
          e.preventDefault();
          if (users.find(u => u.username === newUserForm.username)) {
            showNotification('ชื่อผู้ใช้งานนี้มีในระบบแล้ว', 'error');
            return;
          }
          const newUser = { ...newUserForm, createdAt: Date.now() };
          try {
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), newUser);
            setShowAddUserForm(false);
            setNewUserForm({ name: '', username: '', password: '', role: 'admin', taxId: '' });
            showNotification('เพิ่มผู้ใช้งานลงฐานข้อมูลสำเร็จ');
          } catch (error) {
            showNotification('เกิดข้อผิดพลาดในการเพิ่มผู้ใช้', 'error');
          }
        };

        // ================= ส่วนประกอบ UI: ระบบ Login/Register =================
        if (!currentUser) {
          return (
            <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-brand-50 via-slate-100 to-brand-100 relative overflow-hidden">
              
              {/* พื้นหลังตกแต่ง */}
              <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-brand-400/20 rounded-full blur-3xl pointer-events-none"></div>
              <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-400/20 rounded-full blur-3xl pointer-events-none"></div>

              <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-[900px] overflow-hidden flex flex-col md:flex-row relative z-10 animate-fade-in border border-white/50">
                
                {/* แจ้งเตือนสถานะการเชื่อมต่อ Database */}
                {!isDbReady && (
                  <div className="absolute top-0 left-0 w-full bg-amber-500 text-white text-xs font-heading font-medium text-center py-1.5 animate-pulse z-50 shadow-sm">
                    กำลังเชื่อมต่อฐานข้อมูล Firebase...
                  </div>
                )}

                {/* ฝั่งซ้าย: โลโก้และข้อความต้อนรับ */}
                <div className="md:w-5/12 bg-gradient-to-br from-brand-900 to-brand-700 p-10 text-white flex flex-col justify-center items-center text-center relative overflow-hidden">
                  <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-2xl transform translate-x-1/2 -translate-y-1/2"></div>
                  <div className="absolute bottom-0 left-0 w-48 h-48 bg-black/10 rounded-full blur-xl transform -translate-x-1/2 translate-y-1/2"></div>
                  
                  <div className="bg-white p-4 rounded-2xl shadow-lg mb-8 relative z-10 transform hover:scale-105 transition-transform duration-300">
                    <img src="https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_fovzwgfovzwgfovz.png" alt="โลโก้วัดไชยามาตย์" className="w-32 h-auto object-contain" />
                  </div>
                  
                  <h1 className="text-3xl font-heading font-bold mb-3 relative z-10 tracking-wide shadow-black/10 drop-shadow-md">ระบบ E-Donation</h1>
                  <p className="text-brand-100 font-heading font-medium text-lg relative z-10 bg-white/10 px-4 py-1 rounded-full backdrop-blur-sm border border-white/10">วัดไชยามาตย์</p>
                  
                  <p className="mt-8 text-sm text-brand-100 opacity-90 relative z-10 leading-relaxed font-light">
                    เชื่อมต่อข้อมูลการบริจาคเข้าสู่ระบบ<br/>กรมสรรพากรโดยตรง สะดวก ปลอดภัย<br/>และสามารถตรวจสอบได้
                  </p>
                </div>
                
                {/* ฝั่งขวา: ฟอร์ม */}
                <div className="md:w-7/12 p-8 md:p-12 flex flex-col justify-center bg-white relative">
                  
                  {notification && (
                    <div className={`absolute top-4 right-4 left-4 p-3 rounded-xl flex items-center gap-3 text-sm font-medium shadow-md animate-fade-in z-20 ${notification.type === 'error' ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-green-50 text-green-600 border border-green-100'}`}>
                      {notification.type === 'error' ? <AlertCircle size={18} /> : <CheckCircle2 size={18} />}
                      {notification.message}
                    </div>
                  )}

                  {authMode === 'login' ? (
                    <form onSubmit={handleLogin} className="space-y-5 animate-fade-in mt-4">
                      <div className="text-center mb-8">
                        <h2 className="text-2xl font-heading font-bold text-slate-800">เข้าสู่ระบบ</h2>
                        <p className="text-slate-500 mt-2 text-sm">กรุณากรอกข้อมูลเพื่อเข้าใช้งานระบบ</p>
                      </div>

                      <div>
                        <label className="block text-sm font-heading font-medium text-slate-700 mb-1.5 ml-1">ชื่อผู้ใช้งาน</label>
                        <input type="text" name="username" value={authForm.username} onChange={handleAuthChange} required 
                          className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all text-slate-800" 
                          placeholder="Username" />
                      </div>
                      <div>
                        <label className="block text-sm font-heading font-medium text-slate-700 mb-1.5 ml-1">รหัสผ่าน</label>
                        <input type="password" name="password" value={authForm.password} onChange={handleAuthChange} required 
                          className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all text-slate-800" 
                          placeholder="••••••••" />
                      </div>
                      
                      <button type="submit" disabled={!isDbReady} 
                        className={`w-full text-white py-3.5 rounded-xl font-heading font-semibold text-lg transition-all transform hover:-translate-y-0.5 mt-4 ${isDbReady ? 'bg-brand-900 hover:bg-brand-800 shadow-md hover:shadow-lg' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`}>
                        {isDbReady ? 'เข้าสู่ระบบ' : 'กำลังเตรียมความพร้อม...'}
                      </button>
                      
                      <div className="text-center mt-6 pt-6 border-t border-slate-100">
                        <span className="text-slate-500 text-sm">ผู้บริจาคใหม่? </span>
                        <button type="button" onClick={() => setAuthMode('register')} className="text-brand-600 font-heading font-semibold hover:text-brand-800 hover:underline transition-colors text-sm ml-1">
                          สร้างประวัติการบริจาค
                        </button>
                      </div>
                    </form>
                  ) : (
                    <form onSubmit={handleRegister} className="space-y-4 animate-fade-in mt-4">
                      <div className="text-center mb-6">
                        <h2 className="text-2xl font-heading font-bold text-slate-800">สมัครสมาชิกผู้บริจาค</h2>
                        <p className="text-slate-500 mt-1 text-sm">สร้างบัญชีเพื่อบันทึกประวัติการขอลดหย่อนภาษี</p>
                      </div>

                      <div className="grid grid-cols-1 gap-4">
                        <div>
                          <label className="block text-sm font-heading font-medium text-slate-700 mb-1 ml-1">ชื่อ - นามสกุล</label>
                          <input type="text" name="name" value={authForm.name} onChange={handleAuthChange} required 
                            className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all" />
                        </div>
                        <div>
                          <label className="block text-sm font-heading font-medium text-slate-700 mb-1 ml-1">เลขประจำตัวประชาชน (13 หลัก)</label>
                          <input type="text" name="taxId" value={authForm.taxId} onChange={handleAuthChange} maxLength="13" required 
                            className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all font-mono" />
                          <p className="text-[11px] text-slate-400 mt-1.5 ml-1 flex items-center gap-1"><ShieldCheck size={12}/> ข้อมูลถูกเข้ารหัสและใช้เชื่อมโยงกับสรรพากรเท่านั้น</p>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-heading font-medium text-slate-700 mb-1 ml-1">ชื่อผู้ใช้งาน</label>
                            <input type="text" name="username" value={authForm.username} onChange={handleAuthChange} required 
                              className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all" />
                          </div>
                          <div>
                            <label className="block text-sm font-heading font-medium text-slate-700 mb-1 ml-1">รหัสผ่าน</label>
                            <input type="password" name="password" value={authForm.password} onChange={handleAuthChange} required 
                              className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all" />
                          </div>
                        </div>
                      </div>
                      
                      <button type="submit" disabled={!isDbReady} 
                        className={`w-full text-white py-3 rounded-xl font-heading font-semibold transition-all transform hover:-translate-y-0.5 mt-2 ${isDbReady ? 'bg-brand-900 hover:bg-brand-800 shadow-md' : 'bg-slate-300 cursor-not-allowed'}`}>
                        ยืนยันสมัครสมาชิก
                      </button>
                      
                      <div className="text-center mt-4 pt-4 border-t border-slate-100">
                        <span className="text-slate-500 text-sm">มีบัญชีอยู่แล้ว? </span>
                        <button type="button" onClick={() => setAuthMode('login')} className="text-brand-600 font-heading font-semibold hover:text-brand-800 hover:underline transition-colors text-sm ml-1">
                          กลับไปเข้าสู่ระบบ
                        </button>
                      </div>
                    </form>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // ================= ส่วนประกอบ UI: ระบบหลัง Login =================

        const RenderInstructions = () => (
          <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-4xl mx-auto animate-fade-in">
            <h2 className="text-2xl font-heading font-bold text-brand-900 mb-6 border-b border-slate-100 pb-4 flex items-center gap-3">
              <div className="w-10 h-10 bg-brand-100 text-brand-600 rounded-xl flex items-center justify-center"><Info size={24} /></div>
              คำชี้แจงระบบ E-Donation
            </h2>
            
            <div className="space-y-8 text-slate-600 leading-relaxed">
              <p className="text-lg bg-slate-50 p-5 rounded-xl border border-slate-100">
                ระบบ E-Donation เป็นระบบที่เชื่อมโยงข้อมูลการบริจาคระหว่างหน่วยรับบริจาคและกรมสรรพากร เพื่ออำนวยความสะดวกแก่ผู้บริจาคในการใช้สิทธิประโยชน์ทางภาษี โดย <strong className="text-brand-700">ลดขั้นตอนการจัดเก็บและยื่นเอกสารหลักฐานด้วยตนเอง</strong>
              </p>

              <div>
                <h3 className="text-xl font-heading font-bold text-slate-800 mb-4 flex items-center gap-2">
                  <div className="w-1.5 h-6 bg-blue-500 rounded-full"></div> หลักการทำงานของระบบ
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pl-2">
                  <div className="flex gap-4 p-4 rounded-xl border border-slate-100 bg-white hover:shadow-md transition-shadow">
                    <span className="bg-blue-100 text-blue-700 font-heading font-bold rounded-xl w-10 h-10 flex items-center justify-center shrink-0 text-lg">1</span>
                    <div><strong className="text-slate-800">ผู้บริจาคทำรายการ</strong><br/><span className="text-sm">ระบุข้อมูลที่จำเป็น เช่น เลขประจำตัวผู้เสียภาษีอากร</span></div>
                  </div>
                  <div className="flex gap-4 p-4 rounded-xl border border-slate-100 bg-white hover:shadow-md transition-shadow">
                    <span className="bg-blue-100 text-blue-700 font-heading font-bold rounded-xl w-10 h-10 flex items-center justify-center shrink-0 text-lg">2</span>
                    <div><strong className="text-slate-800">หน่วยรับบริจาคบันทึกข้อมูล</strong><br/><span className="text-sm">เจ้าหน้าที่ตรวจสอบความถูกต้องและบันทึกเข้าระบบ</span></div>
                  </div>
                  <div className="flex gap-4 p-4 rounded-xl border border-slate-100 bg-white hover:shadow-md transition-shadow">
                    <span className="bg-blue-100 text-blue-700 font-heading font-bold rounded-xl w-10 h-10 flex items-center justify-center shrink-0 text-lg">3</span>
                    <div><strong className="text-slate-800">ยืนยันข้อมูลไปยังสรรพากร</strong><br/><span className="text-sm">ข้อมูลถูกส่งไปยังกรมสรรพากรอัตโนมัติ</span></div>
                  </div>
                  <div className="flex gap-4 p-4 rounded-xl border border-slate-100 bg-white hover:shadow-md transition-shadow">
                    <span className="bg-blue-100 text-blue-700 font-heading font-bold rounded-xl w-10 h-10 flex items-center justify-center shrink-0 text-lg">4</span>
                    <div><strong className="text-slate-800">ใช้สิทธิลดหย่อนได้ทันที</strong><br/><span className="text-sm">ปรากฏในระบบภาษีโดยไม่ต้องแนบเอกสารเพิ่ม</span></div>
                  </div>
                </div>
              </div>

              <div>
                <h3 className="text-xl font-heading font-bold text-slate-800 mb-4 flex items-center gap-2">
                  <div className="w-1.5 h-6 bg-emerald-500 rounded-full"></div> ประโยชน์สำหรับผู้บริจาค
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 pl-2">
                  <div className="flex items-center gap-3 p-3 bg-emerald-50/50 rounded-lg"><CheckCircle2 size={20} className="text-emerald-500 shrink-0"/> ไม่ต้องเก็บใบเสร็จรับเงินตัวจริงเพื่อยื่นภาษี</div>
                  <div className="flex items-center gap-3 p-3 bg-emerald-50/50 rounded-lg"><CheckCircle2 size={20} className="text-emerald-500 shrink-0"/> ลดความผิดพลาดจากการกรอกข้อมูลเอง</div>
                  <div className="flex items-center gap-3 p-3 bg-emerald-50/50 rounded-lg"><CheckCircle2 size={20} className="text-emerald-500 shrink-0"/> สะดวก รวดเร็ว และตรวจสอบข้อมูลย้อนหลังได้</div>
                  <div className="flex items-center gap-3 p-3 bg-emerald-50/50 rounded-lg"><CheckCircle2 size={20} className="text-emerald-500 shrink-0"/> เพิ่มความมั่นใจข้อมูลส่งตรงถึงกรมสรรพากร</div>
                </div>
              </div>

              <div className="bg-amber-50 border border-amber-200/60 rounded-xl p-5 shadow-sm">
                <h3 className="text-lg font-heading font-bold text-amber-800 mb-3 flex items-center gap-2">
                  <AlertCircle size={22}/> เงื่อนไขสำคัญ
                </h3>
                <ul className="list-disc pl-6 space-y-2 text-sm text-amber-900/80 marker:text-amber-400">
                  <li>หน่วยรับบริจาคต้องเป็นหน่วยงานที่เข้าร่วมระบบ E-Donation และได้รับอนุมัติจากกรมสรรพากร</li>
                  <li>ผู้บริจาคต้องแจ้งข้อมูลประจำตัวผู้เสียภาษีให้ถูกต้องครบถ้วน</li>
                  <li>สิทธิการหักลดหย่อนเป็นไปตามประเภทของเงินบริจาคและตามที่กฎหมายกำหนด</li>
                  <li>กรณีข้อมูลไม่ถูกต้องหรือยังไม่ได้รับการยืนยัน ข้อมูลจะยังไม่ถูกส่งเข้าสู่ระบบกรมสรรพากร</li>
                </ul>
              </div>

              <div className="pt-8 flex justify-center">
                <button 
                  onClick={() => setActiveMenu('donor_request')}
                  className="bg-brand-900 hover:bg-brand-800 text-white px-8 py-3.5 rounded-2xl font-heading font-semibold text-lg shadow-lg shadow-brand-900/20 hover:shadow-xl hover:-translate-y-1 transition-all flex items-center gap-3"
                >
                  <FileText size={22} /> ยื่นขอลดหย่อนภาษี
                </button>
              </div>
            </div>
          </div>
        );

        const RenderRecordForm = () => {
          const isDonor = currentUser.role === 'donor';
          
          return (
            <div className="max-w-4xl mx-auto bg-white border border-slate-100 rounded-2xl p-6 sm:p-10 shadow-sm animate-fade-in">
              <h2 className="text-2xl font-heading font-bold text-brand-900 mb-8 flex items-center gap-3 border-b border-slate-100 pb-4">
                <div className="w-10 h-10 bg-brand-50 text-brand-600 rounded-xl flex items-center justify-center">
                  {isDonor ? <FileText size={22} /> : <CheckCircle2 size={22} />}
                </div>
                {isDonor ? 'แจ้งขอรับใบลดหย่อนภาษี (E-Donation)' : 'บันทึกรายการเงินบริจาค (Admin)'}
              </h2>
              
              <form onSubmit={handleSubmitDonation} className="space-y-6">
                
                {/* Section: วันที่และประเภท */}
                <div className="bg-slate-50/50 p-5 rounded-xl border border-slate-100 space-y-5">
                  <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6">
                    <label className="sm:w-1/3 text-sm font-heading font-medium text-slate-700 sm:text-right">วันที่บริจาค :</label>
                    <div className="sm:w-2/3">
                      <input type="date" name="date" value={formData.date} onChange={handleInputChange} required 
                        className="px-4 py-2.5 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none w-full sm:w-56 transition-all text-slate-700" />
                    </div>
                  </div>

                  {!isDonor && (
                    <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6">
                      <label className="sm:w-1/3 text-sm font-heading font-medium text-slate-700 sm:text-right">ประเภทการบริจาค <span className="text-red-500">*</span> :</label>
                      <div className="sm:w-2/3 flex items-center gap-6">
                        <label className="flex items-center gap-2 cursor-pointer group">
                          <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${!formData.isAnonymous ? 'border-brand-500 border-4' : 'border-slate-300 group-hover:border-brand-300'}`}></div>
                          <input type="radio" checked={!formData.isAnonymous} onChange={() => setFormData({...formData, isAnonymous: false})} className="hidden" />
                          <span className="text-sm font-medium text-slate-700">ประสงค์ออกนาม</span>
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer group">
                          <div className={`w-5 h-5 rounded-full border flex items-center justify-center ${formData.isAnonymous ? 'border-brand-500 border-4' : 'border-slate-300 group-hover:border-brand-300'}`}></div>
                          <input type="radio" checked={formData.isAnonymous} onChange={() => setFormData({...formData, isAnonymous: true})} className="hidden" />
                          <span className="text-sm font-medium text-slate-700">ไม่ประสงค์ออกนาม</span>
                        </label>
                      </div>
                    </div>
                  )}
                </div>

                {/* Section: ข้อมูลผู้บริจาค */}
                {(!formData.isAnonymous || isDonor) && (
                  <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm space-y-5 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-1 h-full bg-brand-500"></div>
                    
                    <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6">
                      <label className="sm:w-1/3 text-sm font-heading font-medium text-slate-700 sm:text-right leading-tight">เลขประจำตัวประชาชน <span className="text-red-500">*</span> :</label>
                      <div className="sm:w-2/3">
                        <div className="flex gap-2">
                          <input type="text" name="taxId" value={isDonor ? currentUser.taxId : formData.taxId} onChange={handleInputChange} disabled={isDonor} maxLength="13" required 
                            className={`px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none w-full sm:w-56 font-mono text-center tracking-widest ${isDonor ? 'bg-slate-100 text-slate-500 font-semibold' : 'bg-white text-slate-800'}`} placeholder="x-xxxx-xxxxx-xx-x"/>
                          {!isDonor && (
                            <button type="button" onClick={handleVerifyTaxId} className="flex items-center justify-center gap-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 transition-colors px-4 py-2.5 rounded-xl text-sm font-heading font-medium">
                              <SearchCode size={18} /> ค้นหา
                            </button>
                          )}
                        </div>
                      </div>
                    </div>

                    {formData.donorType === 'individual' && (
                      <div className="flex flex-col sm:flex-row gap-2 sm:gap-6 pt-2">
                        <label className="sm:w-1/3 text-sm font-heading font-medium text-slate-700 sm:text-right sm:pt-2">ชื่อ - นามสกุล <span className="text-red-500">*</span> :</label>
                        <div className="sm:w-2/3 flex flex-col sm:flex-row gap-4">
                          <input type="text" name="firstName" value={isDonor ? currentUser.name.split(' ')[0] : formData.firstName} onChange={handleInputChange} disabled={isDonor} required 
                            className={`w-full px-4 py-2.5 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 transition-all ${isDonor ? 'bg-slate-50 text-slate-600' : 'bg-white text-slate-800'}`} placeholder="ชื่อจริง" />
                          <input type="text" name="lastName" value={isDonor ? currentUser.name.split(' ').slice(1).join(' ') : formData.lastName} onChange={handleInputChange} disabled={isDonor} required 
                            className={`w-full px-4 py-2.5 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 transition-all ${isDonor ? 'bg-slate-50 text-slate-600' : 'bg-white text-slate-800'}`} placeholder="นามสกุล" />
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Section: รายการบริจาค */}
                <div className="bg-emerald-50/50 p-5 rounded-xl border border-emerald-100 space-y-4">
                  <div className="flex flex-col sm:flex-row gap-2 sm:gap-6">
                    <label className="sm:w-1/3 text-sm font-heading font-medium text-slate-700 sm:text-right sm:pt-2.5">รายการที่บริจาค <span className="text-red-500">*</span> :</label>
                    <div className="sm:w-2/3 space-y-3">
                      
                      <div className="flex items-center gap-3 bg-white p-2 border border-slate-200 rounded-xl focus-within:ring-2 focus-within:ring-brand-500/20 focus-within:border-brand-400 transition-all shadow-sm">
                        <div className="bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-lg text-sm font-heading font-medium whitespace-nowrap">เงินสด</div>
                        <input type="number" name="cashAmount" value={formData.cashAmount} onChange={handleInputChange} min="0" placeholder="0.00"
                          className="flex-1 bg-transparent px-2 py-1 outline-none text-slate-800 font-medium text-right" />
                        <span className="text-sm font-medium text-slate-500 pr-2">บาท</span>
                      </div>

                      <div className="flex flex-col gap-3 p-3 bg-white border border-slate-200 rounded-xl shadow-sm">
                        <div className="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                          <div className="bg-amber-100 text-amber-700 px-3 py-1.5 rounded-lg text-sm font-heading font-medium whitespace-nowrap">ทรัพย์สิน</div>
                          <input type="text" name="assetName" value={formData.assetName} onChange={handleInputChange} 
                            className="flex-1 w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 outline-none focus:bg-white focus:border-amber-400 text-sm" placeholder="ระบุชื่อทรัพย์สิน เช่น คอมพิวเตอร์" />
                        </div>
                        <div className="flex items-center justify-end gap-3 w-full border-t border-slate-100 pt-3">
                          <span className="text-sm text-slate-500 font-medium">ประเมินมูลค่า :</span>
                          <input type="number" name="assetValue" value={formData.assetValue} onChange={handleInputChange} min="0" placeholder="0.00"
                            className="w-32 bg-slate-50 border border-slate-200 rounded-lg px-3 py-1.5 outline-none focus:bg-white focus:border-amber-400 text-right font-medium" />
                          <span className="text-sm text-slate-500 font-medium">บาท</span>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>

                <div className="flex justify-center pt-6">
                  <button type="submit" className="bg-brand-900 hover:bg-brand-800 text-white px-10 py-3.5 rounded-2xl font-heading font-bold text-lg shadow-lg shadow-brand-900/20 hover:shadow-xl hover:-translate-y-1 transition-all flex items-center gap-3">
                    <FileText size={20} /> {isDonor ? 'ส่งเรื่องแจ้งขอใบลดหย่อน' : 'บันทึกเข้าระบบ'}
                  </button>
                </div>
              </form>
            </div>
          );
        };

        const RenderList = () => {
          const isDonor = currentUser.role === 'donor';
          const displayDonations = isDonor 
            ? donations.filter(d => d.taxId === currentUser.taxId)
            : donations.filter(d => (d.firstName + d.lastName + d.corpName).toLowerCase().includes(searchTerm.toLowerCase()) || (d.taxId && d.taxId.includes(searchTerm)));

          return (
            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden animate-fade-in flex flex-col h-full">
              <div className="p-5 border-b border-slate-100 bg-white flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 className="text-xl font-heading font-bold text-brand-900 flex items-center gap-2">
                  <div className="w-8 h-8 bg-brand-50 text-brand-600 rounded-lg flex items-center justify-center"><Clock size={18}/></div>
                  {isDonor ? 'ประวัติการขอลดหย่อนภาษี' : 'รายการรอตรวจสอบ (Admin)'}
                </h2>
                <div className="flex flex-wrap items-center gap-3 w-full sm:w-auto">
                  {!isDonor && (
                    <>
                      <div className="relative flex-1 sm:w-64">
                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                          <Search size={18} />
                        </span>
                        <input type="text" placeholder="ค้นหาชื่อ, เลขผู้เสียภาษี..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} 
                          className="w-full pl-10 pr-4 py-2 text-sm bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 outline-none transition-all" />
                      </div>
                      <button onClick={exportToCSV} className="flex items-center justify-center gap-2 bg-emerald-50 text-emerald-700 border border-emerald-200 hover:bg-emerald-600 hover:text-white px-4 py-2 rounded-xl text-sm font-heading font-medium transition-colors shadow-sm">
                        <Download size={18} /> ส่งออก CSV
                      </button>
                    </>
                  )}
                </div>
              </div>
              <div className="overflow-x-auto flex-1 custom-scrollbar">
                <table className="w-full text-left text-sm whitespace-nowrap">
                  <thead className="bg-slate-50 text-slate-600 font-heading border-y border-slate-200 sticky top-0 z-10">
                    <tr>
                      <th className="px-5 py-4 font-semibold text-center w-24">วันที่</th>
                      {!isDonor && <th className="px-5 py-4 font-semibold text-center border-l border-slate-200">เลขประจำตัว</th>}
                      <th className="px-5 py-4 font-semibold border-l border-slate-200">{isDonor ? 'รายการบริจาค' : 'ชื่อ-นามสกุล'}</th>
                      <th className="px-5 py-4 font-semibold text-right border-l border-slate-200">มูลค่า (บาท)</th>
                      <th className="px-5 py-4 font-semibold text-center border-l border-slate-200">สถานะ</th>
                      <th className="px-5 py-4 font-semibold text-center border-l border-slate-200">ใบเสร็จ</th>
                      {!isDonor && <th className="px-5 py-4 font-semibold text-center border-l border-slate-200">จัดการ</th>}
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {displayDonations.map((d) => (
                      <tr key={d.id} className="hover:bg-brand-50/30 transition-colors group">
                        <td className="px-5 py-3 text-center text-slate-500">{d.date.split('-').reverse().join('/')}</td>
                        {!isDonor && <td className="px-5 py-3 text-center font-mono text-slate-600 tracking-wider text-[13px]">{d.taxId}</td>}
                        <td className="px-5 py-3 font-medium text-slate-800">
                          {isDonor 
                            ? (
                                <div className="flex items-center gap-2">
                                  {d.cashAmount > 0 && <span className="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-[11px] font-heading">เงินสด</span>}
                                  {d.assetValue > 0 && <span className="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-[11px] font-heading">{d.assetName || 'ทรัพย์สิน'}</span>}
                                </div>
                              )
                            : `${d.prefix || ''}${d.firstName} ${d.lastName}`.trim()
                          }
                        </td>
                        <td className="px-5 py-3 text-right text-brand-700 font-bold text-[15px]">
                          {(d.cashAmount + d.assetValue).toLocaleString()}
                        </td>
                        <td className="px-5 py-3 text-center">
                          {d.status === 'approved' 
                            ? <span className="inline-flex items-center gap-1 text-[12px] font-heading font-medium bg-green-100/80 text-green-700 px-2.5 py-1 rounded-lg border border-green-200"><CheckCircle size={14} /> อนุมัติแล้ว</span>
                            : <span className="inline-flex items-center gap-1 text-[12px] font-heading font-medium bg-amber-100/80 text-amber-700 px-2.5 py-1 rounded-lg border border-amber-200"><Clock size={14} /> รอตรวจสอบ</span>
                          }
                        </td>
                        <td className="px-5 py-3 text-center">
                          {d.status === 'approved' ? (
                            <button onClick={() => handleDownloadReceipt(d)} className="text-brand-600 hover:text-white bg-brand-50 hover:bg-brand-600 border border-brand-200 text-[12px] font-heading font-medium flex items-center justify-center gap-1.5 w-full p-1.5 rounded-lg transition-all shadow-sm">
                              <Download size={14} /> {isDonor ? 'ใบเสร็จรับเงิน' : 'พิมพ์'}
                            </button>
                          ) : (
                            <span className="text-slate-300 text-xs">-</span>
                          )}
                        </td>
                        {!isDonor && (
                          <td className="px-5 py-3 text-center flex justify-center gap-2 items-center">
                            {d.status === 'pending' && approveInputId !== d.id && (
                              <button onClick={() => { setApproveInputId(d.id); setReceiptNoInput(''); }} className="text-green-700 hover:text-white bg-green-50 hover:bg-green-600 p-1.5 rounded-lg border border-green-200 transition-colors tooltip" title="อนุมัติรายการ">
                                <CheckCircle2 size={18} />
                              </button>
                            )}
                            {approveInputId === d.id && (
                              <div className="flex items-center gap-1 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                                <input type="text" value={receiptNoInput} onChange={(e) => setReceiptNoInput(e.target.value)} placeholder="เลขที่ใบเสร็จ e-Donation" className="text-xs px-2 py-1.5 border border-slate-200 rounded-md w-36 outline-none focus:ring-1 focus:ring-brand-500 font-mono" autoFocus />
                                <button onClick={() => confirmApprove(d.id)} className="bg-green-600 text-white px-2 py-1.5 rounded-md text-xs hover:bg-green-700 font-heading">บันทึก</button>
                                <button onClick={() => setApproveInputId(null)} className="bg-slate-200 text-slate-600 px-2 py-1.5 rounded-md text-xs hover:bg-slate-300 font-heading">ยกเลิก</button>
                              </div>
                            )}
                            {approveInputId !== d.id && (
                              <button onClick={() => handleDelete(d.id)} className="text-red-500 hover:text-white bg-red-50 hover:bg-red-500 p-1.5 rounded-lg border border-red-200 transition-colors opacity-50 group-hover:opacity-100" title="ลบรายการ">
                                <Trash2 size={18}/>
                              </button>
                            )}
                          </td>
                        )}
                      </tr>
                    ))}
                    {displayDonations.length === 0 && (
                      <tr>
                        <td colSpan={isDonor ? 5 : 7} className="px-5 py-16 text-center text-slate-400 font-medium">
                          <div className="flex flex-col items-center gap-2">
                            <FileText size={32} className="opacity-50" />
                            ยังไม่มีข้อมูลการบริจาค
                          </div>
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        const adminMenus = [
          { id: 'list', label: 'ตรวจสอบและอนุมัติ', icon: <Clock size={20} /> },
          { id: 'record', label: 'บันทึกรายการบริจาค', icon: <CheckCircle2 size={20} /> },
          { id: 'report', label: 'รายงานสรุปยอด', icon: <BarChart3 size={20} /> },
          { id: 'manageUsers', label: 'จัดการผู้ใช้งาน', icon: <Users size={20} /> },
        ];

        const donorMenus = [
          { id: 'instructions', label: 'คำชี้แจงระบบ', icon: <Info size={20} /> },
          { id: 'donor_history', label: 'ประวัติของฉัน', icon: <Clock size={20} /> },
          { id: 'donor_request', label: 'ขอลดหย่อนใหม่', icon: <FileText size={20} /> },
        ];

        const menuItems = currentUser.role === 'admin' ? adminMenus : donorMenus;

        return (
          <div className="flex h-screen bg-slate-50 font-sans overflow-hidden">
            
            {/* Sidebar Modernized */}
            <div className={`${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} fixed md:relative z-30 w-72 h-full bg-white border-r border-slate-200 flex flex-col transition-transform duration-300 ease-in-out shadow-xl md:shadow-none`}>
              {/* Header Sidebar */}
              <div className="py-6 px-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div className="flex items-center gap-3">
                  <img src="https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_fovzwgfovzwgfovz.png" className="h-8 w-auto object-contain" alt="Logo"/>
                </div>
                <button className="md:hidden text-slate-400 hover:text-slate-600" onClick={() => setIsSidebarOpen(false)}><X size={24} /></button>
              </div>
              
              {/* User Profile Area */}
              <div className="mx-4 my-4 p-4 rounded-2xl bg-gradient-to-br from-brand-50 to-brand-100/50 border border-brand-100 flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-brand-900 text-white flex items-center justify-center font-heading font-bold shadow-sm">
                  {currentUser.name.charAt(0)}
                </div>
                <div className="flex-1 overflow-hidden">
                  <p className="font-heading font-bold text-brand-900 text-sm truncate">{currentUser.name}</p>
                  <p className="text-[11px] font-medium text-brand-600 bg-brand-200/50 px-2 py-0.5 rounded-md inline-block mt-1">
                    {currentUser.role === 'admin' ? 'ผู้ดูแลระบบ (Admin)' : 'ผู้บริจาค (Donor)'}
                  </p>
                </div>
              </div>
              
              <div className="flex-1 overflow-y-auto py-2 custom-scrollbar">
                <p className="px-6 text-xs font-heading font-bold text-slate-400 uppercase tracking-wider mb-2 mt-2">เมนูหลัก</p>
                {menuItems.map((menu) => {
                  const isActive = activeMenu === menu.id;
                  return (
                    <button
                      key={menu.id}
                      onClick={() => { setActiveMenu(menu.id); if(window.innerWidth < 768) setIsSidebarOpen(false); }}
                      className={`w-[calc(100%-2rem)] mx-4 my-1 px-4 py-3 rounded-xl text-[15px] transition-all duration-200 flex items-center gap-3 font-heading ${
                        isActive 
                          ? 'bg-brand-900 text-white font-semibold shadow-md shadow-brand-900/20' 
                          : 'text-slate-600 font-medium hover:bg-slate-100 hover:text-brand-900'
                      }`}
                    >
                      <span className={isActive ? 'text-brand-200' : 'text-slate-400'}>{menu.icon}</span> 
                      {menu.label}
                    </button>
                  );
                })}
              </div>

              <div className="p-4 border-t border-slate-100">
                <button onClick={handleLogout} className="w-full text-red-600 bg-red-50 hover:bg-red-100 hover:text-red-700 py-3 rounded-xl font-heading font-semibold transition-colors flex items-center justify-center gap-2 border border-red-100">
                  <LogOut size={18} /> ออกจากระบบ
                </button>
              </div>
            </div>

            <div className="flex-1 flex flex-col h-screen relative overflow-hidden">
              {/* Mobile Header */}
              <header className="bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 flex items-center justify-between shadow-sm md:hidden sticky top-0 z-20">
                <div className="flex items-center gap-3">
                  <button onClick={() => setIsSidebarOpen(true)} className="text-brand-900 bg-brand-50 p-2 rounded-lg"><Menu size={24} /></button>
                  <img src="https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_fovzwgfovzwgfovz.png" className="h-6 w-auto" alt="Logo"/>
                </div>
              </header>

              <main className="flex-1 overflow-y-auto p-4 sm:p-8 bg-slate-50 custom-scrollbar relative">
                {/* Background Decor */}
                <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-brand-100/40 rounded-full blur-[100px] pointer-events-none -z-10"></div>
                
                {notification && (
                  <div className={`mb-6 p-4 rounded-2xl flex items-center gap-3 shadow-lg animate-fade-in ${
                    notification.type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'
                  }`}>
                    {notification.type === 'error' ? <AlertCircle size={22} /> : <CheckCircle2 size={22} />}
                    <p className="font-medium">{notification.message}</p>
                  </div>
                )}

                <div className="pb-10 max-w-7xl mx-auto h-full">
                  {activeMenu === 'instructions' && RenderInstructions()}
                  {activeMenu === 'record' && RenderRecordForm()}
                  {activeMenu === 'donor_request' && RenderRecordForm()}
                  {activeMenu === 'list' && RenderList()}
                  {activeMenu === 'donor_history' && RenderList()}
                  
                  {activeMenu === 'report' && (
                    <div className="space-y-6 animate-fade-in">
                      <h2 className="text-2xl font-heading font-bold text-brand-900 flex items-center gap-3">
                        <div className="w-10 h-10 bg-brand-50 text-brand-600 rounded-xl flex items-center justify-center"><BarChart3 size={24}/></div> 
                        รายงานสรุปยอดเงินบริจาค
                      </h2>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white rounded-3xl shadow-sm border border-slate-100 p-8 flex flex-col items-center justify-center text-center relative overflow-hidden group hover:shadow-md transition-shadow">
                          <div className="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
                          <div className="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-5 group-hover:scale-110 transition-transform"><CheckCircle2 size={28} /></div>
                          <p className="text-slate-500 font-heading font-medium text-sm">รายการที่อนุมัติแล้ว</p>
                          <p className="text-4xl font-bold text-slate-800 mt-2">{donations.filter(d => d.status === 'approved').length} <span className="text-base font-normal text-slate-400">รายการ</span></p>
                        </div>
                        <div className="bg-white rounded-3xl shadow-sm border border-slate-100 p-8 flex flex-col items-center justify-center text-center relative overflow-hidden group hover:shadow-md transition-shadow">
                          <div className="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
                          <div className="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mb-5 group-hover:scale-110 transition-transform"><PieChart size={28} /></div>
                          <p className="text-slate-500 font-heading font-medium text-sm">ยอดเงินสดรวมที่อนุมัติ</p>
                          <p className="text-4xl font-bold text-emerald-600 mt-2">{donations.filter(d => d.status === 'approved').reduce((sum, d) => sum + (d.cashAmount || 0), 0).toLocaleString()} <span className="text-base font-normal text-slate-400">บาท</span></p>
                        </div>
                        <div className="bg-white rounded-3xl shadow-sm border border-slate-100 p-8 flex flex-col items-center justify-center text-center relative overflow-hidden group hover:shadow-md transition-shadow">
                          <div className="absolute top-0 left-0 w-full h-1 bg-amber-500"></div>
                          <div className="w-14 h-14 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center mb-5 group-hover:scale-110 transition-transform"><FileText size={28} /></div>
                          <p className="text-slate-500 font-heading font-medium text-sm">ยอดมูลค่าทรัพย์สินรวม</p>
                          <p className="text-4xl font-bold text-amber-600 mt-2">{donations.filter(d => d.status === 'approved').reduce((sum, d) => sum + (d.assetValue || 0), 0).toLocaleString()} <span className="text-base font-normal text-slate-400">บาท</span></p>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {activeMenu === 'manageUsers' && (
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden animate-fade-in">
                      <div className="p-5 border-b border-slate-100 bg-white flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h2 className="text-xl font-heading font-bold text-brand-900 flex items-center gap-3">
                           <div className="w-8 h-8 bg-brand-50 text-brand-600 rounded-lg flex items-center justify-center"><Users size={18}/></div>
                           จัดการผู้ใช้งานระบบ
                        </h2>
                        <button onClick={() => setShowAddUserForm(!showAddUserForm)} className={`text-white px-4 py-2 rounded-xl text-sm font-heading font-medium flex items-center gap-2 shadow-sm transition-all ${showAddUserForm ? 'bg-slate-500 hover:bg-slate-600' : 'bg-brand-900 hover:bg-brand-800'}`}>
                          {showAddUserForm ? <X size={16} /> : <UserPlus size={16} />} 
                          {showAddUserForm ? 'ยกเลิกการเพิ่ม' : 'เพิ่มผู้ใช้งานใหม่'}
                        </button>
                      </div>

                      {showAddUserForm && (
                        <div className="p-6 border-b border-slate-100 bg-slate-50/50">
                          <form onSubmit={handleAddUserSubmit} className="max-w-4xl bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-5">
                            <h3 className="font-heading font-bold text-slate-800 border-b border-slate-100 pb-3 mb-4">ฟอร์มเพิ่มผู้ใช้งาน</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                              <div>
                                <label className="block text-sm font-heading font-medium text-slate-700 mb-1 ml-1">ชื่อ-นามสกุล / ตำแหน่ง</label>
                                <input type="text" required value={newUserForm.name} onChange={(e) => setNewUserForm({...newUserForm, name: e.target.value})} className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all" />
                              </div>
                              <div>
                                <label className="block text-sm font-heading font-medium text-slate-700 mb-1 ml-1">เลขประจำตัว 13 หลัก <span className="text-slate-400 font-normal">(ถ้ามี)</span></label>
                                <input type="text" maxLength="13" value={newUserForm.taxId} onChange={(e) => setNewUserForm({...newUserForm, taxId: e.target.value})} className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all font-mono" placeholder="ไม่ต้องกรอกก็ได้ถ้าเป็นแอดมิน" />
                              </div>
                              <div>
                                <label className="block text-sm font-heading font-medium text-slate-700 mb-1 ml-1">ชื่อผู้ใช้งาน (Username)</label>
                                <input type="text" required value={newUserForm.username} onChange={(e) => setNewUserForm({...newUserForm, username: e.target.value})} className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all" />
                              </div>
                              <div>
                                <label className="block text-sm font-heading font-medium text-slate-700 mb-1 ml-1">รหัสผ่าน (Password)</label>
                                <input type="password" required value={newUserForm.password} onChange={(e) => setNewUserForm({...newUserForm, password: e.target.value})} className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all" />
                              </div>
                              <div className="md:col-span-2">
                                <label className="block text-sm font-heading font-medium text-slate-700 mb-1 ml-1">สิทธิ์การใช้งาน</label>
                                <select value={newUserForm.role} onChange={(e) => setNewUserForm({...newUserForm, role: e.target.value})} className="w-full md:w-1/2 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 outline-none transition-all">
                                  <option value="admin">เจ้าหน้าที่ (Admin)</option>
                                  <option value="donor">ผู้บริจาค (Donor)</option>
                                </select>
                              </div>
                            </div>
                            <div className="pt-4 flex justify-end">
                              <button type="submit" className="bg-emerald-600 text-white px-8 py-2.5 rounded-xl font-heading font-medium hover:bg-emerald-700 transition shadow-sm hover:shadow-md hover:-translate-y-0.5">บันทึกผู้ใช้งาน</button>
                            </div>
                          </form>
                        </div>
                      )}

                      <div className="overflow-x-auto custom-scrollbar">
                        <table className="w-full text-left text-sm whitespace-nowrap">
                          <thead className="bg-slate-50 text-slate-600 font-heading border-y border-slate-200">
                            <tr>
                              <th className="px-5 py-4 font-semibold w-1/4">ชื่อ-นามสกุล</th>
                              <th className="px-5 py-4 font-semibold border-l border-slate-200">ชื่อผู้ใช้งาน</th>
                              <th className="px-5 py-4 font-semibold border-l border-slate-200">บทบาท</th>
                              <th className="px-5 py-4 font-semibold text-center border-l border-slate-200">เลขประจำตัว 13 หลัก</th>
                              <th className="px-5 py-4 font-semibold text-center border-l border-slate-200">จัดการ</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100">
                            {users.map((u) => (
                              <tr key={u.id} className="hover:bg-slate-50 transition-colors">
                                <td className="px-5 py-3 font-medium text-slate-800">{u.name}</td>
                                <td className="px-5 py-3 text-slate-500">{u.username}</td>
                                <td className="px-5 py-3">
                                  {u.role === 'admin' 
                                    ? <span className="bg-purple-100 text-purple-700 px-2.5 py-1 rounded-md text-[12px] font-heading font-medium border border-purple-200">เจ้าหน้าที่ (Admin)</span>
                                    : <span className="bg-blue-100 text-blue-700 px-2.5 py-1 rounded-md text-[12px] font-heading font-medium border border-blue-200">ผู้บริจาค (Donor)</span>
                                  }
                                </td>
                                <td className="px-5 py-3 text-center font-mono text-slate-500 tracking-wider text-[13px]">{u.taxId || '-'}</td>
                                <td className="px-5 py-3 text-center">
                                  <button onClick={() => showNotification(`ระงับการใช้งาน ${u.name} แล้ว`, 'error')} className="text-red-500 hover:text-white bg-red-50 hover:bg-red-500 px-3 py-1.5 rounded-lg text-xs font-heading font-medium border border-red-200 transition-colors">ระงับผู้ใช้</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              </main>
            </div>

            {/* Overlay for Mobile Sidebar */}
            {isSidebarOpen && <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-20 md:hidden animate-fade-in" onClick={() => setIsSidebarOpen(false)}></div>}
          </div>
        );
      }

      // แสดงผลแอปพลิเคชัน
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    };
    
    // เริ่มทำงานระบบ
    startApp();
  </script>
</body>
</html>
