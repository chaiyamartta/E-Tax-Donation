<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบ E-Donation วัดไชยามาตย์</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { 
      font-family: 'Sarabun', Tahoma, sans-serif; 
    }
    .animate-fade-in { 
      animation: fadeIn 0.3s ease-in-out; 
    }
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(-10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- โหลด Firebase SDK แบบ Module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ส่งออกไปยัง window object เพื่อให้โค้ดฝั่ง React นำไปใช้งานได้
    window.firebaseModules = {
      initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc
    };
  </script>

  <!-- เขียนแอปพลิเคชัน React -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ================= SVG Icons (จำลองจาก lucide-react) =================
    const Icon = ({ paths, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {paths}
      </svg>
    );

    const Download = (p) => <Icon {...p} paths={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />;
    const Search = (p) => <Icon {...p} paths={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />;
    const FileText = (p) => <Icon {...p} paths={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />;
    const CheckCircle2 = (p) => <Icon {...p} paths={<><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></>} />;
    const CheckCircle = CheckCircle2;
    const AlertCircle = (p) => <Icon {...p} paths={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />;
    const Trash2 = (p) => <Icon {...p} paths={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />;
    const SearchCode = (p) => <Icon {...p} paths={<><path d="m13 13.5 2-2.5-2-2.5"/><path d="m21 21-4.3-4.3"/><path d="M9 8.5 7 11l2 2.5"/><circle cx="11" cy="11" r="8"/></>} />;
    const UploadCloud = (p) => <Icon {...p} paths={<><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="16 16 12 12 8 16"/></>} />;
    const BarChart3 = (p) => <Icon {...p} paths={<><path d="M3 3v18h18"/><rect width="4" height="7" x="7" y="10" rx="1"/><rect width="4" height="12" x="15" y="5" rx="1"/></>} />;
    const UserPlus = (p) => <Icon {...p} paths={<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>} />;
    const Users = (p) => <Icon {...p} paths={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
    const Menu = (p) => <Icon {...p} paths={<><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></>} />;
    const X = (p) => <Icon {...p} paths={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />;
    const PieChart = (p) => <Icon {...p} paths={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>} />;
    const LogOut = (p) => <Icon {...p} paths={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>} />;
    const User = (p) => <Icon {...p} paths={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
    const Clock = (p) => <Icon {...p} paths={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
    const Info = (p) => <Icon {...p} paths={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>} />;

    // ฟังก์ชันเริ่มการทำงานของแอป
    const startApp = () => {
      // ตรวจสอบว่า Firebase โหลดเสร็จหรือยัง (ป้องกัน Race Condition)
      if (!window.firebaseModules) {
        setTimeout(startApp, 50); // ถ้ายังไม่เสร็จให้รอ 50ms แล้วเช็คใหม่
        return;
      }

      const { 
        initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
        getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc
      } = window.firebaseModules;

      // ================= Firebase Setup =================
      const firebaseConfig = {
        apiKey: "AIzaSyDWY0la-lGPQEsEB0NNwhXWenoPJDjtwNk",
        authDomain: "e-donation-e-tax.firebaseapp.com",
        projectId: "e-donation-e-tax",
        storageBucket: "e-donation-e-tax.firebasestorage.app",
        messagingSenderId: "933266533512",
        appId: "1:933266533512:web:0502c4a72d1df16d1bc33d",
        measurementId: "G-TTNTG4SG0V"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ใช้ APP_ID เพื่อแยกพื้นที่เก็บข้อมูล
      const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'edonation-chaiyamat';

      function App() {
        const [approveInputId, setApproveInputId] = useState(null);
        const [receiptNoInput, setReceiptNoInput] = useState('');

        // ================= State สำหรับระบบ Auth และ Firebase =================
        const [firebaseUser, setFirebaseUser] = useState(null);
        const [isDbReady, setIsDbReady] = useState(false);
        const [currentUser, setCurrentUser] = useState(null); // null = ยังไม่ล็อกอินเข้าสู่ระบบวัด
        const [authMode, setAuthMode] = useState('login'); // 'login' | 'register'
        
        // State สำหรับจัดการหน้าจอและเมนู
        const [activeMenu, setActiveMenu] = useState('');
        const [isSidebarOpen, setIsSidebarOpen] = useState(true);
        const [notification, setNotification] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        
        // State สำหรับเพิ่มผู้ใช้งานใหม่
        const [showAddUserForm, setShowAddUserForm] = useState(false);
        const [newUserForm, setNewUserForm] = useState({ name: '', username: '', password: '', role: 'admin', taxId: '' });

        // ================= ข้อมูลจากฐานข้อมูล Firebase =================
        const [users, setUsers] = useState([]);
        const [donations, setDonations] = useState([]);

        // ================= 초기化 Firebase & Fetch Data =================
        useEffect(() => {
          // 1. ตรวจสอบสิทธิ์ Firebase โดยใช้ Token ของระบบ (ถ้ามี) หรือ Anonymous Auth
          const initAuth = async () => {
            try {
              if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                  // ระบบจะพยายามล็อกอินด้วย Token ของระบบก่อน
                  await signInWithCustomToken(auth, __initial_auth_token);
                } catch (tokenError) {
                  // หากเกิด Custom Token Mismatch (เพราะเชื่อมต่อ Firebase ส่วนตัว) ให้สลับมาใช้ Anonymous
                  console.warn("ใช้ Firebase ส่วนตัว: สลับเป็น Anonymous Auth");
                  await signInAnonymously(auth);
                }
              } else {
                await signInAnonymously(auth);
              }
            } catch (error) {
              console.error("Firebase Auth Error:", error);
            }
          };
          initAuth();

          const unsubscribeAuth = onAuthStateChanged(auth, user => {
            setFirebaseUser(user);
          });

          return () => unsubscribeAuth();
        }, []);

        useEffect(() => {
          if (!firebaseUser) return;

          // 2. ดึงข้อมูลแบบ Real-time จาก Firestore
          const donationsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'donations');
          const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');

          const unsubDonations = onSnapshot(donationsRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // เรียงจากใหม่ไปเก่า
            data.sort((a, b) => b.createdAt - a.createdAt);
            setDonations(data);
          }, (error) => console.error(error));

          const unsubUsers = onSnapshot(usersRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Seed ข้อมูลเบื้องต้นหากฐานข้อมูลว่างเปล่า
            if (data.length === 0) {
              addDoc(usersRef, { username: 'admin', password: 'password', name: 'เจ้าหน้าที่ วัดไชยามาตย์', role: 'admin', taxId: '' });
              addDoc(usersRef, { username: 'jaidee', password: 'password', name: 'นาย ใจดี มีบุญ', role: 'donor', taxId: '1101400012345' });
            } else {
              setUsers(data);
              setIsDbReady(true);
            }
          }, (error) => console.error(error));

          return () => {
            unsubDonations();
            unsubUsers();
          };
        }, [firebaseUser]);

        const initialFormState = {
          date: new Date().toISOString().split('T')[0], isAnonymous: false, donorType: 'individual',
          taxId: '', prefix: '', firstName: '', lastName: '', corpName: '', cashAmount: '', assetName: '', assetValue: '', note: ''
        };
        const [formData, setFormData] = useState(initialFormState);
        const [authForm, setAuthForm] = useState({ username: '', password: '', name: '', taxId: '' });

        // ================= ฟังก์ชันช่วยเหลือ =================
        const showNotification = (message, type = 'success') => {
          setNotification({ message, type });
          setTimeout(() => setNotification(null), 3000);
        };

        const handleInputChange = (e) => {
          const { name, value, type, checked } = e.target;
          setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
        };

        const handleAuthChange = (e) => {
          setAuthForm({ ...authForm, [e.target.name]: e.target.value });
        };

        const handleVerifyTaxId = () => {
          if (formData.taxId.length === 13) {
            const foundDonation = donations.find(d => d.taxId === formData.taxId);
            const foundUser = users.find(u => u.taxId === formData.taxId);

            if (foundDonation) {
              setFormData(prev => ({
                ...prev,
                donorType: foundDonation.donorType || 'individual',
                prefix: foundDonation.prefix || '',
                firstName: foundDonation.firstName || '',
                lastName: foundDonation.lastName || '',
                corpName: foundDonation.corpName || ''
              }));
              showNotification('พบข้อมูลในระบบ ทำการดึงข้อมูลเรียบร้อย', 'success');
            } else if (foundUser) {
              const nameParts = foundUser.name.split(' ');
              setFormData(prev => ({
                ...prev,
                donorType: 'individual',
                firstName: nameParts[0] || '',
                lastName: nameParts.slice(1).join(' ') || ''
              }));
              showNotification('พบประวัติผู้ใช้งาน ทำการดึงข้อมูลเรียบร้อย', 'success');
            } else {
              showNotification('ไม่พบข้อมูลในระบบ สามารถกรอกข้อมูลใหม่ได้เลย', 'success');
            }
          } else {
            showNotification('กรุณากรอกเลขประจำตัว 13 หลัก', 'error');
          }
        };

        // ฟังก์ชันเข้าสู่ระบบ
        const handleLogin = (e) => {
          e.preventDefault();
          if(!isDbReady) {
            showNotification('กำลังเชื่อมต่อฐานข้อมูล กรุณารอสักครู่', 'error');
            return;
          }
          const user = users.find(u => u.username === authForm.username && u.password === authForm.password);
          if (user) {
            setCurrentUser(user);
            setActiveMenu(user.role === 'admin' ? 'list' : 'instructions');
            showNotification(`ยินดีต้อนรับคุณ ${user.name}`);
            setAuthForm({ username: '', password: '', name: '', taxId: '' });
          } else {
            showNotification('ชื่อผู้ใช้งานหรือรหัสผ่านไม่ถูกต้อง', 'error');
          }
        };

        // ฟังก์ชันสมัครสมาชิก
        const handleRegister = async (e) => {
          e.preventDefault();
          if (users.find(u => u.username === authForm.username)) {
            showNotification('ชื่อผู้ใช้งานนี้มีในระบบแล้ว', 'error'); return;
          }
          if (authForm.taxId.length !== 13) {
            showNotification('กรุณากรอกเลขประจำตัว 13 หลัก', 'error'); return;
          }
          const newUser = {
            username: authForm.username,
            password: authForm.password,
            name: authForm.name,
            role: 'donor',
            taxId: authForm.taxId,
            createdAt: Date.now()
          };
          
          // บันทึกลง Firebase
          try {
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), newUser);
            setAuthMode('login');
            showNotification('สมัครสมาชิกสำเร็จ กรุณาเข้าสู่ระบบ');
          } catch (err) {
            showNotification('เกิดข้อผิดพลาดในการสมัครสมาชิก', 'error');
          }
        };

        const handleLogout = () => {
          setCurrentUser(null);
          setActiveMenu('');
        };

        // บันทึกการบริจาค (รองรับทั้ง Admin และ Donor) -> อัปเดตขึ้น Firebase
        const handleSubmitDonation = async (e) => {
          e.preventDefault();
          
          const actualTaxId = currentUser.role === 'donor' ? currentUser.taxId : formData.taxId;
          const actualFirstName = currentUser.role === 'donor' ? currentUser.name.split(' ')[0] : formData.firstName;
          const actualLastName = currentUser.role === 'donor' ? currentUser.name.split(' ').slice(1).join(' ') : formData.lastName;

          if (!formData.isAnonymous && actualTaxId.length !== 13) {
            showNotification('กรุณากรอกเลขประจำตัว 13 หลักให้ถูกต้อง', 'error'); return;
          }
          const cash = parseFloat(formData.cashAmount) || 0;
          const asset = parseFloat(formData.assetValue) || 0;
          if (cash <= 0 && asset <= 0) {
            showNotification('ต้องระบุจำนวนเงินสดหรือมูลค่าทรัพย์สินอย่างน้อย 1 รายการ', 'error'); return;
          }

          const status = currentUser.role === 'admin' ? 'approved' : 'pending';

          const newDonation = { 
            ...formData, 
            taxId: actualTaxId,
            firstName: actualFirstName,
            lastName: actualLastName,
            cashAmount: cash, 
            assetValue: asset, 
            status,
            createdAt: Date.now()
          };
          
          try {
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'donations'), newDonation);
            setFormData(initialFormState);
            
            if (currentUser.role === 'admin') {
              showNotification('บันทึกข้อมูลการบริจาคลงระบบสำเร็จ');
              setActiveMenu('list');
            } else {
              showNotification('ส่งรายการแจ้งบริจาคเรียบร้อย รอเจ้าหน้าที่ตรวจสอบ');
              setActiveMenu('donor_history');
            }
          } catch (error) {
            showNotification('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
          }
        };

        const confirmApprove = async (id) => {
          if (!receiptNoInput.trim()) {
            showNotification('กรุณากรอกเลขที่ใบเสร็จให้ครบถ้วน', 'error');
            return;
          }
          
          try {
            const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'donations', id);
            await updateDoc(docRef, { status: 'approved', receiptNo: receiptNoInput.trim() });
            showNotification(`อนุมัติและอัปเดตเลขที่ใบเสร็จ "${receiptNoInput}" สำเร็จ`);
            setApproveInputId(null);
            setReceiptNoInput('');
          } catch (error) {
            showNotification('เกิดข้อผิดพลาดในการอัปเดตข้อมูล', 'error');
          }
        };

        // ฟังก์ชันช่วยเหลือสำหรับฟอร์แมตใบเสร็จ
        const formatThaiDate = (dateString) => {
          if (!dateString) return '';
          const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
          const d = new Date(dateString);
          return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
        };

        const formatDateTimeThai = (date) => {
          const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
          const pad = (n) => n.toString().padStart(2, '0');
          return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
        };

        const formatTaxId = (id) => {
          if (!id || id.length !== 13) return id;
          return `${id[0]} ${id.substring(1, 5)} ${id.substring(5, 10)} ${id.substring(10, 12)} ${id[12]}`;
        };

        const getThaiBahtText = (amount) => {
          const number = Math.round(amount * 100) / 100;
          if (number === 0) return 'ศูนย์บาทถ้วน';
          const t1 = ["", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า"];
          const t2 = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"];
          let numStr = number.toFixed(2).split('.');
          let baht = numStr[0];
          let satang = numStr[1];
          
          let result = "";
          const readPart = (str) => {
            let res = "";
            for (let i = 0; i < str.length; i++) {
              let n = parseInt(str[i]);
              let pos = str.length - i - 1;
              if (n !== 0) {
                if (pos === 0 && n === 1 && str.length > 1 && str[i-1] !== '0') res += "เอ็ด";
                else if (pos === 1 && n === 1) res += "";
                else if (pos === 1 && n === 2) res += "ยี่";
                else res += t1[n];
                res += t2[pos];
              }
            }
            return res;
          };
          
          if (baht !== "0") result += readPart(baht) + "บาท";
          if (satang === "00") result += "ถ้วน";
          else result += readPart(satang) + "สตางค์";
          return result;
        };

        const handleDownloadReceipt = (donation) => {
          const printWindow = window.open('', '_blank');
          
          // เตรียมข้อมูลสำหรับแสดงผล
          const donorName = donation.donorType === 'individual' 
            ? `${donation.prefix || ''}${donation.firstName} ${donation.lastName}`.trim()
            : donation.corpName;
          const totalAmount = (donation.cashAmount || 0) + (donation.assetValue || 0);
          const formattedTaxId = formatTaxId(donation.taxId);
          const printDateTime = formatDateTimeThai(new Date());
          const donationDateThai = formatThaiDate(donation.date);
          const bahtText = getThaiBahtText(totalAmount);
          const receiptNo = donation.receiptNo || '-';

          printWindow.document.write(`
            <html>
              <head>
                <title>ใบเสร็จ e-Donation - ${donorName}</title>
                <style>
                  @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
                  body { font-family: 'Sarabun', sans-serif; padding: 40px; color: #1a1a1a; line-height: 1.5; background-color: #fff; margin: 0; }
                  .receipt-container { max-width: 900px; margin: 0 auto; position: relative; z-index: 1; padding: 20px; }
                  
                  /* Watermark styling */
                  .watermark {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 450px;
                    opacity: 0.08; /* ปรับความจางของลายน้ำที่นี่ */
                    z-index: -1;
                    pointer-events: none;
                  }
                  
                  /* Header & Logos */
                  .header-row-1 { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; }
                  .logo-container { display: flex; align-items: baseline; }
                  .logo-e { font-size: 40px; font-weight: 700; color: #433385; font-style: italic; letter-spacing: -2px; }
                  .logo-e-shadow { position: relative; }
                  .logo-e-shadow::before { content: '• • •'; font-size: 14px; color: #433385; position: absolute; left: -15px; top: 15px; letter-spacing: -1px; transform: rotate(-15deg); }
                  .logo-text { font-size: 26px; font-weight: 700; color: #666; margin-left: 2px; }
                  .receipt-title { font-size: 32px; font-weight: 700; color: #2e377d; }
                  
                  /* Sub headers */
                  .header-row-2 { display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 10px; color: #333; }
                  .divider { height: 1.5px; background-color: #d1d5db; margin-bottom: 25px; }
                  
                  /* Main Grid Content */
                  .content-grid { display: grid; grid-template-columns: 200px 1fr; row-gap: 25px; margin-bottom: 60px; }
                  .label { font-size: 20px; font-weight: 700; color: #000; padding-top: 2px; text-align: left; }
                  .details { display: flex; flex-direction: column; }
                  .val-title { font-size: 20px; font-weight: 700; color: #000; }
                  .val-sub { font-size: 16px; font-weight: 400; color: #000; margin-top: 6px; }
                  .val-sub strong { font-weight: 700; }
                  
                  /* Signatures Footer */
                  .signatures { display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; margin-top: 80px; align-items: end; }
                  .sig-left { text-align: left; font-size: 12px; color: #333; }
                  .sig-center { text-align: center; }
                  .sig-name { font-size: 18px; font-weight: 700; color: #000; margin-bottom: 5px; }
                  .sig-role { font-size: 18px; font-weight: 700; color: #000; }
                  .sig-right { text-align: right; }
                  .sig-date-title { font-size: 18px; font-weight: 700; color: #000; margin-bottom: 5px; }
                  .sig-print-date { font-size: 16px; font-weight: 700; color: #000; }
                  
                  /* Notes */
                  .notes { margin-top: 20px; font-size: 12px; color: #333; line-height: 1.6; }
                  .notes-flex { display: flex; }
                  .notes-label { white-space: nowrap; margin-right: 5px; }
                  
                  @media print {
                    body { padding: 0; }
                    .receipt-container { max-width: 100%; padding: 0; }
                    .watermark {
                      -webkit-print-color-adjust: exact;
                      print-color-adjust: exact;
                    }
                  }
                </style>
              </head>
              <body>
                <div class="receipt-container">
                  <!-- ภาพลายน้ำตรงกลาง -->
                  <img src="https://img2.pic.in.th/pic/-Ver.3-1.png" alt="watermark" class="watermark" />
                  
                  <div class="header-row-1">
                    <div class="logo-container logo-e-shadow">
                      <span class="logo-e">e-</span><span class="logo-text">Donation</span>
                    </div>
                    <div class="receipt-title">ใบรับเงินบริจาค</div>
                  </div>
                  <div class="header-row-2">
                    <div>ระบบบริจาคอิเล็กทรอนิกส์ (e-Donation) กรมสรรพากร</div>
                    <div><strong>เลขที่</strong> ${receiptNo}</div>
                  </div>
                  
                  <div class="divider"></div>
                  
                  <div class="content-grid">
                    <div class="label">ผู้บริจาค</div>
                    <div class="details">
                      <div class="val-title">${donorName}</div>
                      <div class="val-sub">เลขประจำตัวประชาชน / เลขประจำตัวผู้เสียภาษีอากร <strong>${formattedTaxId}</strong></div>
                    </div>
                    
                    <div class="label">หน่วยรับบริจาค</div>
                    <div class="details">
                      <div class="val-title">วัดไชยามาตย์</div>
                      <div class="val-sub">ตำบล/แขวง เวียงทอง อำเภอ/เขต สูงเม่น จังหวัด แพร่</div>
                      <div class="val-sub">เลขประจำตัวหน่วยรับบริจาค <strong>0 9940 02406 46 8</strong></div>
                    </div>
                    
                    <div class="label">วันที่บริจาค</div>
                    <div class="details">
                      <div class="val-title">${donationDateThai}</div>
                    </div>
                    
                    <div class="label">จำนวนเงินบริจาค</div>
                    <div class="details">
                      <div class="val-title">${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท</div>
                      <div class="val-sub">( ${bahtText} )</div>
                    </div>
                  </div>
                  
                  <div class="signatures">
                    <div class="sig-left">
                      DN: 12e82105
                    </div>
                    <div class="sig-center">
                      <div class="sig-name">พระครู วิจารณ์ธรรมภิวัฒน์ (อนันต์ เวียงโอสถ)</div>
                      <div class="sig-role">ผู้มีอำนาจลงนาม</div>
                    </div>
                    <div class="sig-right">
                      <div class="sig-date-title">วันเดือนปีที่ขอพิมพ์</div>
                      <div class="sig-print-date">${printDateTime}</div>
                    </div>
                  </div>
                  
                  <div class="notes">
                    <div class="notes-flex">
                      <div class="notes-label">หมายเหตุ : </div>
                      <div>
                        1. ข้อมูลบริจาคของท่านได้บันทึกไว้ในระบบบริจาคอิเล็กทรอนิกส์ (e-Donation) ท่านสามารถตรวจสอบได้ที่เว็บไซต์กรมสรรพากร (www.rd.go.th)<br>
                        2. กรมสรรพากรเป็นเพียงผู้ให้บริการระบบบริจาคอิเล็กทรอนิกส์ (e-Donation) กรณีที่ท่านต้องการแก้ไข หรือยกเลิกหรือสอบถามเกี่ยวกับรายการบริจาค<br>
                        &nbsp;&nbsp;&nbsp;ของท่านสามารถสอบถามได้ที่หน่วยรับบริจาคที่ท่านทำรายการ
                      </div>
                    </div>
                  </div>
                </div>
                <script>
                  // สั่งพิมพ์อัตโนมัติเมื่อหน้าเว็บโหลดเสร็จ
                  window.onload = function() {
                    window.print();
                  }
                <\/script>
              </body>
            </html>
          `);
          printWindow.document.close();
        };

        const handleDelete = async (id) => {
          if(window.confirm('คุณต้องการลบรายการนี้ใช่หรือไม่?')) {
            try {
              const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'donations', id);
              await deleteDoc(docRef);
              showNotification('ลบรายการสำเร็จ');
            } catch (error) {
              showNotification('เกิดข้อผิดพลาดในการลบข้อมูล', 'error');
            }
          }
        }

        const exportToCSV = () => {
          const BOM = '\uFEFF';
          const headers = 'วันที่รับบริจาค,ประเภทผู้บริจาค,เลขประจำตัวผู้เสียภาษีอากร,คำนำหน้าชื่อ,ชื่อ,นามสกุล,ชื่อนิติบุคคล,มูลค่าเงินสด,รายการทรัพย์สิน,มูลค่าทรัพย์สิน\n';
          const approvedDonations = donations.filter(d => d.status === 'approved');
          
          const csvContent = approvedDonations.map(d => {
            const [year, month, day] = d.date.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            const donorTypeText = d.donorType === 'individual' ? 'บุคคลธรรมดา' : 'นิติบุคคล';
            return `"${formattedDate}","${donorTypeText}","${d.taxId}","${d.prefix}","${d.firstName}","${d.lastName}","${d.corpName}","${d.cashAmount || 0}","${d.assetName}","${d.assetValue || 0}"`;
          }).join('\n');

          const blob = new Blob([BOM + headers + csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `e-donation_export_${new Date().toISOString().split('T')[0]}.csv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        const handleAddUserSubmit = async (e) => {
          e.preventDefault();
          if (users.find(u => u.username === newUserForm.username)) {
            showNotification('ชื่อผู้ใช้งานนี้มีในระบบแล้ว', 'error');
            return;
          }
          const newUser = { ...newUserForm, createdAt: Date.now() };
          try {
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'), newUser);
            setShowAddUserForm(false);
            setNewUserForm({ name: '', username: '', password: '', role: 'admin', taxId: '' });
            showNotification('เพิ่มผู้ใช้งานลงฐานข้อมูลสำเร็จ');
          } catch (error) {
            showNotification('เกิดข้อผิดพลาดในการเพิ่มผู้ใช้', 'error');
          }
        };

        // ================= ส่วนประกอบ UI: ระบบ Login/Register =================
        if (!currentUser) {
          return (
            <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden border border-slate-200 relative">
                
                {/* แจ้งเตือนสถานะการเชื่อมต่อ Database */}
                {!isDbReady && (
                  <div className="absolute top-0 left-0 w-full bg-amber-500 text-white text-xs text-center py-1 animate-pulse">
                    กำลังเชื่อมต่อฐานข้อมูล Firebase...
                  </div>
                )}

                <div className="bg-[#1e3b6d] p-6 text-center text-white mt-4">
                  <div className="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <FileText size={32} />
                  </div>
                  <h1 className="text-2xl font-bold">ระบบ E-Donation</h1>
                  <p className="text-sky-200 text-sm mt-1">วัดไชยามาตย์ (เชื่อมต่อ Cloud)</p>
                </div>
                
                <div className="p-8">
                  {notification && (
                    <div className={`mb-4 p-3 rounded-lg flex items-center gap-2 text-sm ${notification.type === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`}>
                      {notification.type === 'error' ? <AlertCircle size={16} /> : <CheckCircle2 size={16} />}
                      {notification.message}
                    </div>
                  )}

                  {authMode === 'login' ? (
                    <form onSubmit={handleLogin} className="space-y-4">
                      <h2 className="text-xl font-bold text-slate-800 text-center mb-6">เข้าสู่ระบบ</h2>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">ชื่อผู้ใช้งาน</label>
                        <input type="text" name="username" value={authForm.username} onChange={handleAuthChange} required className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1e3b6d] outline-none" placeholder="Username" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน</label>
                        <input type="password" name="password" value={authForm.password} onChange={handleAuthChange} required className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1e3b6d] outline-none" placeholder="Password" />
                      </div>
                      <button type="submit" disabled={!isDbReady} className={`w-full text-white py-2.5 rounded-lg font-medium transition mt-2 ${isDbReady ? 'bg-[#1e3b6d] hover:bg-[#152a4e]' : 'bg-slate-400 cursor-not-allowed'}`}>
                        {isDbReady ? 'เข้าสู่ระบบ' : 'กำลังเชื่อมต่อข้อมูล...'}
                      </button>
                      <div className="text-center mt-4">
                        <span className="text-slate-500 text-sm">ผู้บริจาคใหม่? </span>
                        <button type="button" onClick={() => setAuthMode('register')} className="text-[#1e3b6d] font-medium hover:underline text-sm">สมัครสมาชิก (สร้างประวัติ)</button>
                      </div>
                    </form>
                  ) : (
                    <form onSubmit={handleRegister} className="space-y-4">
                      <h2 className="text-xl font-bold text-slate-800 text-center mb-6">สมัครสมาชิกผู้บริจาค</h2>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">ชื่อ - นามสกุล</label>
                        <input type="text" name="name" value={authForm.name} onChange={handleAuthChange} required className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1e3b6d] outline-none" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">เลขประจำตัวประชาชน (13 หลัก)</label>
                        <input type="text" name="taxId" value={authForm.taxId} onChange={handleAuthChange} maxLength="13" required className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1e3b6d] outline-none" />
                        <p className="text-xs text-slate-500 mt-1">* ใช้สำหรับเชื่อมโยงประวัติการขอลดหย่อนภาษี</p>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">ตั้งชื่อผู้ใช้งาน (Username)</label>
                        <input type="text" name="username" value={authForm.username} onChange={handleAuthChange} required className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1e3b6d] outline-none" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">ตั้งรหัสผ่าน (Password)</label>
                        <input type="password" name="password" value={authForm.password} onChange={handleAuthChange} required className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1e3b6d] outline-none" />
                      </div>
                      <button type="submit" disabled={!isDbReady} className={`w-full text-white py-2.5 rounded-lg font-medium transition mt-2 ${isDbReady ? 'bg-[#1e3b6d] hover:bg-[#152a4e]' : 'bg-slate-400 cursor-not-allowed'}`}>ยืนยันสมัครสมาชิก</button>
                      <div className="text-center mt-4">
                        <span className="text-slate-500 text-sm">มีบัญชีอยู่แล้ว? </span>
                        <button type="button" onClick={() => setAuthMode('login')} className="text-[#1e3b6d] font-medium hover:underline text-sm">กลับไปเข้าสู่ระบบ</button>
                      </div>
                    </form>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // ================= ส่วนประกอบ UI: ระบบหลัง Login =================

        const RenderInstructions = () => (
          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-8 max-w-4xl mx-auto">
            <h2 className="text-2xl font-bold text-[#1e3b6d] mb-6 border-b pb-4 flex items-center gap-2">
              <Info size={28} className="text-sky-600" /> คำชี้แจงระบบ E-Donation
            </h2>
            
            <div className="space-y-8 text-slate-700 leading-relaxed">
              <p className="text-lg">
                ระบบ E-Donation เป็นระบบที่เชื่อมโยงข้อมูลการบริจาคระหว่างหน่วยรับบริจาคและกรมสรรพากร เพื่ออำนวยความสะดวกแก่ผู้บริจาคในการใช้สิทธิประโยชน์ทางภาษี โดยลดขั้นตอนการจัดเก็บและยื่นเอกสารหลักฐานด้วยตนเอง
              </p>

              <div>
                <h3 className="text-lg font-bold text-[#1e3b6d] mb-3 flex items-center gap-2">
                  <div className="w-2 h-6 bg-sky-500 rounded"></div> หลักการทำงานของระบบ
                </h3>
                <ul className="space-y-3 pl-2">
                  <li className="flex gap-3">
                    <span className="bg-sky-100 text-sky-700 font-bold rounded-full w-6 h-6 flex items-center justify-center shrink-0">1</span>
                    <div><strong>ผู้บริจาคทำรายการบริจาค</strong><br/>ระบุข้อมูลที่จำเป็น เช่น เลขประจำตัวผู้เสียภาษีอากร หรือเลขบัตรประชาชน</div>
                  </li>
                  <li className="flex gap-3">
                    <span className="bg-sky-100 text-sky-700 font-bold rounded-full w-6 h-6 flex items-center justify-center shrink-0">2</span>
                    <div><strong>หน่วยรับบริจาคบันทึกข้อมูลเข้าสู่ระบบ E-Donation</strong><br/>พร้อมตรวจสอบความถูกต้องของข้อมูลผู้บริจาคและจำนวนเงิน</div>
                  </li>
                  <li className="flex gap-3">
                    <span className="bg-sky-100 text-sky-700 font-bold rounded-full w-6 h-6 flex items-center justify-center shrink-0">3</span>
                    <div><strong>หน่วยรับบริจาคทำการยืนยันข้อมูล</strong><br/>เมื่อยืนยันแล้ว ข้อมูลจะถูกส่งไปยังกรมสรรพากรโดยอัตโนมัติผ่านระบบอิเล็กทรอนิกส์</div>
                  </li>
                  <li className="flex gap-3">
                    <span className="bg-sky-100 text-sky-700 font-bold rounded-full w-6 h-6 flex items-center justify-center shrink-0">4</span>
                    <div><strong>กรมสรรพากรบันทึกข้อมูลเพื่อใช้สิทธิลดหย่อนภาษี</strong><br/>ข้อมูลการบริจาคจะปรากฏในระบบภาษีเงินได้ของผู้บริจาค โดยไม่ต้องแนบเอกสารเพิ่มเติม (ภายใต้เงื่อนไขที่กฎหมายกำหนด)</div>
                  </li>
                </ul>
              </div>

              <div>
                <h3 className="text-lg font-bold text-[#1e3b6d] mb-3 flex items-center gap-2">
                  <div className="w-2 h-6 bg-emerald-500 rounded"></div> ประโยชน์สำหรับผู้บริจาค
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 pl-2">
                  <div className="flex items-center gap-2"><CheckCircle2 size={18} className="text-emerald-500 shrink-0"/> ไม่ต้องเก็บใบเสร็จรับเงินตัวจริงเพื่อยื่นภาษี</div>
                  <div className="flex items-center gap-2"><CheckCircle2 size={18} className="text-emerald-500 shrink-0"/> ลดความผิดพลาดจากการกรอกข้อมูลเอง</div>
                  <div className="flex items-center gap-2"><CheckCircle2 size={18} className="text-emerald-500 shrink-0"/> สะดวก รวดเร็ว และตรวจสอบข้อมูลย้อนหลังได้</div>
                  <div className="flex items-center gap-2"><CheckCircle2 size={18} className="text-emerald-500 shrink-0"/> เพิ่มความมั่นใจว่าข้อมูลถูกส่งตรงถึงกรมสรรพากร</div>
                </div>
              </div>

              <div className="bg-amber-50 border border-amber-200 rounded-lg p-5">
                <h3 className="text-md font-bold text-amber-800 mb-3 flex items-center gap-2">
                  <AlertCircle size={20}/> เงื่อนไขสำคัญ
                </h3>
                <ul className="list-disc pl-5 space-y-2 text-sm text-amber-900">
                  <li>หน่วยรับบริจาคต้องเป็นหน่วยงานที่เข้าร่วมระบบ E-Donation และได้รับอนุมัติจากกรมสรรพากร</li>
                  <li>ผู้บริจาคต้องแจ้งข้อมูลประจำตัวผู้เสียภาษีให้ถูกต้องครบถ้วน</li>
                  <li>สิทธิการหักลดหย่อนเป็นไปตามประเภทของเงินบริจาคและตามที่กฎหมายกำหนด</li>
                  <li>กรณีข้อมูลไม่ถูกต้องหรือยังไม่ได้รับการยืนยัน ข้อมูลจะยังไม่ถูกส่งเข้าสู่ระบบกรมสรรพากร</li>
                </ul>
              </div>

              <div className="bg-red-50 border border-red-200 rounded-lg p-5 mt-4">
                <h3 className="text-lg font-bold text-red-800 mb-2 flex items-center gap-2">
                  <AlertCircle size={24}/> เน้นย้ำ
                </h3>
                <p className="text-red-700 font-bold text-lg">
                  ระบบนี้เป็นระบบสำหรับหน่วยรับบริจาค "วัดไชยามาตย์" เท่านั้น
                </p>
              </div>

              <div className="pt-8 flex justify-center">
                <button 
                  onClick={() => setActiveMenu('donor_request')}
                  className="bg-[#1e3b6d] hover:bg-[#152a4e] text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-3 transform hover:-translate-y-1"
                >
                  <FileText size={24} /> ยื่นขอลดหย่อนภาษี
                </button>
              </div>
            </div>
          </div>
        );

        const RenderRecordForm = () => {
          const isDonor = currentUser.role === 'donor';
          
          return (
            <div className="max-w-4xl mx-auto bg-slate-50 border border-slate-200 rounded-lg p-6 sm:p-10 shadow-sm">
              <h2 className="text-xl font-bold text-[#1e3b6d] mb-6 flex items-center gap-2 border-b pb-3">
                <FileText /> {isDonor ? 'แจ้งขอรับใบลดหย่อนภาษี (E-Donation)' : 'บันทึกรายการเงินบริจาค (Admin)'}
              </h2>
              <form onSubmit={handleSubmitDonation} className="space-y-6">
                <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                  <label className="sm:w-1/3 text-sm font-medium text-slate-700 sm:text-right">วันที่บริจาค :</label>
                  <div className="sm:w-2/3"><input type="date" name="date" value={formData.date} onChange={handleInputChange} required className="px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-[#1e3b6d] outline-none w-48" /></div>
                </div>

                {!isDonor && (
                  <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                    <label className="sm:w-1/3 text-sm font-medium text-slate-700 sm:text-right">ประเภทการบริจาค <span className="text-red-500">*</span> :</label>
                    <div className="sm:w-2/3 flex items-center gap-4">
                      <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={!formData.isAnonymous} onChange={() => setFormData({...formData, isAnonymous: false})} className="text-[#1e3b6d]" /><span className="text-sm">ประสงค์ออกนาม</span></label>
                      <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={formData.isAnonymous} onChange={() => setFormData({...formData, isAnonymous: true})} className="text-[#1e3b6d]" /><span className="text-sm">ไม่ประสงค์ออกนาม</span></label>
                    </div>
                  </div>
                )}

                {(!formData.isAnonymous || isDonor) && (
                  <>
                    <div className="flex flex-col sm:flex-row sm:items-start gap-2 sm:gap-4 pt-2">
                      <label className="sm:w-1/3 text-sm font-medium text-slate-700 sm:text-right leading-tight">เลขประจำตัวประชาชน <span className="text-red-500">*</span> :</label>
                      <div className="sm:w-2/3">
                        <div className="flex gap-2">
                          <input type="text" name="taxId" value={isDonor ? currentUser.taxId : formData.taxId} onChange={handleInputChange} disabled={isDonor} maxLength="13" required className={`px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-[#1e3b6d] outline-none w-48 ${isDonor ? 'bg-slate-200 text-slate-600' : ''}`} />
                          {!isDonor && (
                            <button type="button" onClick={handleVerifyTaxId} className="flex items-center gap-1 bg-[#5bc0de] hover:bg-[#46b8da] transition-colors text-white px-3 py-2 rounded text-sm shadow-sm">
                              <SearchCode size={16} /> ตรวจสอบ
                            </button>
                          )}
                        </div>
                      </div>
                    </div>

                    {formData.donorType === 'individual' ? (
                      <div className="space-y-4 pt-2">
                        <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                          <label className="sm:w-1/3 text-sm font-medium text-slate-700 sm:text-right">ชื่อ <span className="text-red-500">*</span> :</label>
                          <div className="sm:w-2/3 flex flex-col sm:flex-row gap-4">
                            <input type="text" name="firstName" value={isDonor ? currentUser.name.split(' ')[0] : formData.firstName} onChange={handleInputChange} disabled={isDonor} required className="w-full px-3 py-1.5 border-b border-slate-300 focus:border-[#1e3b6d] outline-none bg-transparent" placeholder="ชื่อจริง" />
                            <div className="flex items-center gap-2 w-full">
                              <label className="text-sm font-medium text-slate-700 whitespace-nowrap">นามสกุล <span className="text-red-500">*</span> :</label>
                              <input type="text" name="lastName" value={isDonor ? currentUser.name.split(' ').slice(1).join(' ') : formData.lastName} onChange={handleInputChange} disabled={isDonor} required className="w-full px-3 py-1.5 border-b border-slate-300 focus:border-[#1e3b6d] outline-none bg-transparent" />
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : null}
                  </>
                )}

                <hr className="border-slate-200" />

                <div className="flex flex-col sm:flex-row gap-2 sm:gap-4">
                  <label className="sm:w-1/3 text-sm font-medium text-slate-700 sm:text-right pt-2">รายการที่บริจาค <span className="text-red-500">*</span> :</label>
                  <div className="sm:w-2/3 space-y-3">
                    <div className="flex items-center gap-2">
                      <span className="text-sm w-16">เงินสด :</span>
                      <input type="number" name="cashAmount" value={formData.cashAmount} onChange={handleInputChange} min="0" className="px-3 py-1.5 border border-slate-300 rounded w-48 focus:ring-1 focus:ring-[#1e3b6d] outline-none" />
                      <span className="text-sm">บาท</span>
                    </div>
                    <div className="flex flex-col sm:flex-row sm:items-center gap-2">
                      <div className="flex items-center gap-2">
                        <span className="text-sm w-16">ทรัพย์สิน :</span>
                        <input type="text" name="assetName" value={formData.assetName} onChange={handleInputChange} className="px-3 py-1.5 border border-slate-300 rounded w-48 focus:ring-1 focus:ring-[#1e3b6d] outline-none" placeholder="เช่น ข้าวสาร, คอมพิวเตอร์" />
                      </div>
                      <div className="flex items-center gap-2 pl-[72px] sm:pl-0">
                        <span className="text-sm">มูลค่า :</span>
                        <input type="number" name="assetValue" value={formData.assetValue} onChange={handleInputChange} min="0" className="px-3 py-1.5 border border-slate-300 rounded w-32 focus:ring-1 focus:ring-[#1e3b6d] outline-none" />
                        <span className="text-sm">บาท</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex justify-center gap-3 pt-6">
                  <button type="submit" className="bg-[#1e3b6d] hover:bg-[#152a4e] text-white px-6 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-colors">
                    <FileText size={18} /> {isDonor ? 'ส่งแจ้งขอใบลดหย่อน' : 'บันทึกเข้าระบบ'}
                  </button>
                </div>
              </form>
            </div>
          );
        };

        const RenderList = () => {
          const isDonor = currentUser.role === 'donor';
          const displayDonations = isDonor 
            ? donations.filter(d => d.taxId === currentUser.taxId)
            : donations.filter(d => (d.firstName + d.lastName + d.corpName).toLowerCase().includes(searchTerm.toLowerCase()) || (d.taxId && d.taxId.includes(searchTerm)));

          return (
            <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
              <div className="p-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-50">
                <h2 className="text-lg font-bold text-[#1e3b6d]">
                  {isDonor ? 'ประวัติการขอลดหย่อนภาษีของฉัน' : 'รายการตรวจสอบและส่งออก (Admin)'}
                </h2>
                <div className="flex gap-2">
                  {!isDonor && (
                    <>
                      <div className="relative w-64">
                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                          <Search size={16} />
                        </span>
                        <input type="text" placeholder="ค้นหาชื่อ, เลขผู้เสียภาษี..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-3 py-1.5 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-sky-500 outline-none" />
                      </div>
                      <button onClick={exportToCSV} className="flex items-center gap-2 bg-emerald-600 text-white px-3 py-1.5 rounded text-sm hover:bg-emerald-700 transition shadow-sm">
                        <Download size={16} /> Export CSV สรรพากร
                      </button>
                    </>
                  )}
                </div>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-left text-sm whitespace-nowrap">
                  <thead className="bg-[#b3d4fc] text-slate-800 border-b border-slate-300">
                    <tr>
                      <th className="px-4 py-3 border-r border-slate-300 text-center font-semibold">วันที่บริจาค</th>
                      {!isDonor && <th className="px-4 py-3 border-r border-slate-300 text-center font-semibold">เลขประชาชน</th>}
                      <th className="px-4 py-3 border-r border-slate-300 text-center font-semibold">{isDonor ? 'รายการ' : 'ชื่อ-นามสกุล'}</th>
                      <th className="px-4 py-3 border-r border-slate-300 text-center font-semibold">มูลค่ารวม (บาท)</th>
                      <th className="px-4 py-3 border-r border-slate-300 text-center font-semibold">สถานะ</th>
                      <th className="px-4 py-3 border-r border-slate-300 text-center font-semibold">เอกสาร (PDF)</th>
                      {!isDonor && <th className="px-4 py-3 text-center font-semibold">จัดการ</th>}
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-200">
                    {displayDonations.map((d) => (
                      <tr key={d.id} className="hover:bg-slate-50">
                        <td className="px-4 py-3 border-r border-slate-200 text-center">{d.date.split('-').reverse().join('/')}</td>
                        {!isDonor && <td className="px-4 py-3 border-r border-slate-200 text-center font-mono">{d.taxId}</td>}
                        <td className="px-4 py-3 border-r border-slate-200">
                          {isDonor 
                            ? (d.cashAmount > 0 && d.assetValue > 0 ? 'เงินสด และ ทรัพย์สิน' : d.cashAmount > 0 ? 'เงินสด' : d.assetName)
                            : `${d.prefix}${d.firstName} ${d.lastName}`
                          }
                        </td>
                        <td className="px-4 py-3 border-r border-slate-200 text-right text-[#1e3b6d] font-bold">
                          {(d.cashAmount + d.assetValue).toLocaleString()}
                        </td>
                        <td className="px-4 py-3 border-r border-slate-200 text-center">
                          {d.status === 'approved' 
                            ? <span className="inline-flex items-center gap-1 text-xs font-medium bg-green-100 text-green-700 px-2 py-1 rounded-full"><CheckCircle size={14} /> อนุมัติแล้ว</span>
                            : <span className="inline-flex items-center gap-1 text-xs font-medium bg-amber-100 text-amber-700 px-2 py-1 rounded-full"><Clock size={14} /> รอดำเนินการ</span>
                          }
                        </td>
                        <td className="px-4 py-3 border-r border-slate-200 text-center">
                          {d.status === 'approved' ? (
                            <button onClick={() => handleDownloadReceipt(d)} className="text-sky-600 hover:text-sky-800 text-xs font-medium flex items-center justify-center gap-1 w-full p-1 rounded hover:bg-sky-50 transition-colors">
                              <Download size={14} /> {isDonor ? 'โหลดใบเสร็จ' : 'ดู PDF / พิมพ์'}
                            </button>
                          ) : (
                            <span className="text-slate-400 text-xs">-</span>
                          )}
                        </td>
                        {!isDonor && (
                          <td className="px-4 py-3 text-center flex justify-center gap-2">
                            {d.status === 'pending' && approveInputId !== d.id && (
                              <button onClick={() => { setApproveInputId(d.id); setReceiptNoInput(''); }} className="text-green-600 hover:text-green-800 bg-green-50 px-2 py-1 rounded text-xs border border-green-200 flex items-center gap-1">
                                <CheckCircle2 size={14} /> อนุมัติ
                              </button>
                            )}
                            {approveInputId === d.id && (
                              <div className="flex items-center gap-1">
                                <input type="text" value={receiptNoInput} onChange={(e) => setReceiptNoInput(e.target.value)} placeholder="เลขที่ใบเสร็จ" className="text-xs px-2 py-1 border rounded w-32 outline-none focus:ring-1 focus:ring-green-500" autoFocus />
                                <button onClick={() => confirmApprove(d.id)} className="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">ตกลง</button>
                                <button onClick={() => setApproveInputId(null)} className="bg-slate-400 text-white px-2 py-1 rounded text-xs hover:bg-slate-500">ยกเลิก</button>
                              </div>
                            )}
                            {approveInputId !== d.id && (
                              <button onClick={() => handleDelete(d.id)} className="text-red-500 hover:text-red-700 bg-red-50 px-2 py-1 rounded text-xs border border-red-200"><Trash2 size={14}/></button>
                            )}
                          </td>
                        )}
                      </tr>
                    ))}
                    {displayDonations.length === 0 && (
                      <tr>
                        <td colSpan={isDonor ? 5 : 7} className="px-4 py-8 text-center text-slate-500">
                          ไม่พบข้อมูลการบริจาค
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        const adminMenus = [
          { id: 'list', label: 'ตรวจสอบรายการและส่งออก', icon: <FileText size={18} /> },
          { id: 'record', label: 'บันทึกรายการ (Admin)', icon: <CheckCircle2 size={18} /> },
          { id: 'report', label: 'รายงานสรุปยอดเงินบริจาค', icon: <BarChart3 size={18} /> },
          { id: 'manageUsers', label: 'จัดการผู้ใช้งานระบบ', icon: <Users size={18} /> },
        ];

        const donorMenus = [
          { id: 'instructions', label: 'คำชี้แจงระบบ', icon: <Info size={18} /> },
          { id: 'donor_history', label: 'ประวัติการขอใบลดหย่อน', icon: <Clock size={18} /> },
          { id: 'donor_request', label: 'แจ้งขอใบลดหย่อนใหม่', icon: <FileText size={18} /> },
        ];

        const menuItems = currentUser.role === 'admin' ? adminMenus : donorMenus;

        return (
          <div className="flex h-screen bg-[#f8f9fa] font-sans overflow-hidden">
            
            <div className={`${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} fixed md:relative z-20 w-72 h-full bg-[#f1f5f9] border-r border-slate-300 flex flex-col transition-transform duration-300 ease-in-out`}>
              <div className="bg-[#1e3b6d] text-white py-4 px-6 shadow-md z-10">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-lg font-bold">เมนูการทำงาน</span>
                  <button className="md:hidden text-white hover:text-sky-200" onClick={() => setIsSidebarOpen(false)}><X size={24} /></button>
                </div>
                <div className="flex items-center gap-2 text-sm text-sky-200 border-t border-sky-800 pt-2 mt-2">
                  <User size={16} />
                  <div className="truncate">
                    <p className="font-medium text-white">{currentUser.name}</p>
                    <p className="text-xs">{currentUser.role === 'admin' ? 'ผู้ดูแลระบบ' : 'ผู้บริจาค'}</p>
                  </div>
                </div>
              </div>
              
              <div className="flex-1 overflow-y-auto py-2">
                {menuItems.map((menu) => (
                  <button
                    key={menu.id}
                    onClick={() => { setActiveMenu(menu.id); if(window.innerWidth < 768) setIsSidebarOpen(false); }}
                    className={`w-full text-left px-6 py-4 border-b border-slate-300 text-[15px] transition-colors flex items-center gap-3 ${
                      activeMenu === menu.id 
                        ? 'bg-white text-[#1e3b6d] font-bold border-l-4 border-l-[#1e3b6d]' 
                        : 'text-[#1e3b6d] font-medium hover:bg-[#e2e8f0]'
                    }`}
                  >
                    {menu.icon} {menu.label}
                  </button>
                ))}
              </div>

              <div onClick={handleLogout} className="bg-red-50 text-red-600 py-4 px-6 font-bold cursor-pointer hover:bg-red-100 transition-colors flex items-center justify-center gap-2 border-t border-slate-300">
                <LogOut size={18} /> ออกจากระบบ
              </div>
            </div>

            <div className="flex-1 flex flex-col h-screen relative overflow-hidden">
              <header className="bg-white border-b border-slate-200 p-4 flex items-center justify-between shadow-sm md:hidden">
                <div className="flex items-center gap-3">
                  <button onClick={() => setIsSidebarOpen(true)} className="text-[#1e3b6d]"><Menu size={24} /></button>
                  <h1 className="font-bold text-[#1e3b6d]">E-Donation</h1>
                </div>
              </header>

              <main className="flex-1 overflow-y-auto p-4 sm:p-8 bg-slate-100/50">
                {notification && (
                  <div className={`mb-6 p-4 rounded-lg flex items-center gap-3 shadow-sm animate-fade-in ${
                    notification.type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'
                  }`}>
                    {notification.type === 'error' ? <AlertCircle size={20} /> : <CheckCircle2 size={20} />}
                    <p>{notification.message}</p>
                  </div>
                )}

                <div className="pb-20">
                  {activeMenu === 'instructions' && <RenderInstructions />}
                  {activeMenu === 'record' && <RenderRecordForm />}
                  {activeMenu === 'donor_request' && <RenderRecordForm />}
                  {activeMenu === 'list' && <RenderList />}
                  {activeMenu === 'donor_history' && <RenderList />}
                  
                  {activeMenu === 'report' && (
                    <div className="space-y-6">
                      <h2 className="text-xl font-bold text-[#1e3b6d] flex items-center gap-2"><BarChart3 /> รายงานสรุปยอดเงินบริจาค</h2>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col items-center justify-center text-center">
                          <div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-4"><CheckCircle2 size={24} /></div>
                          <p className="text-slate-500 font-medium">รายการที่อนุมัติแล้ว</p>
                          <p className="text-3xl font-bold text-[#1e3b6d] mt-2">{donations.filter(d => d.status === 'approved').length} <span className="text-lg font-normal">รายการ</span></p>
                        </div>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col items-center justify-center text-center border-b-4 border-b-emerald-500">
                          <div className="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mb-4"><PieChart size={24} /></div>
                          <p className="text-slate-500 font-medium">ยอดเงินสดรวมที่อนุมัติ</p>
                          <p className="text-3xl font-bold text-emerald-600 mt-2">{donations.filter(d => d.status === 'approved').reduce((sum, d) => sum + (d.cashAmount || 0), 0).toLocaleString()} <span className="text-lg font-normal">บาท</span></p>
                        </div>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col items-center justify-center text-center border-b-4 border-b-amber-500">
                          <div className="w-12 h-12 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mb-4"><FileText size={24} /></div>
                          <p className="text-slate-500 font-medium">ยอดมูลค่าทรัพย์สินรวม</p>
                          <p className="text-3xl font-bold text-amber-600 mt-2">{donations.filter(d => d.status === 'approved').reduce((sum, d) => sum + (d.assetValue || 0), 0).toLocaleString()} <span className="text-lg font-normal">บาท</span></p>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {activeMenu === 'manageUsers' && (
                    <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                      <div className="p-4 border-b border-slate-200 bg-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h2 className="text-lg font-bold text-[#1e3b6d] flex items-center gap-2"><Users /> จัดการผู้ใช้งานระบบ</h2>
                        <button onClick={() => setShowAddUserForm(!showAddUserForm)} className="bg-[#1e3b6d] text-white px-3 py-1.5 rounded text-sm hover:bg-[#152a4e] flex items-center gap-1 shadow-sm">
                          {showAddUserForm ? <X size={16} /> : <UserPlus size={16} />} 
                          {showAddUserForm ? 'ยกเลิก' : 'เพิ่มผู้ใช้งาน'}
                        </button>
                      </div>

                      {showAddUserForm && (
                        <div className="p-6 border-b border-slate-200 bg-sky-50/50">
                          <form onSubmit={handleAddUserSubmit} className="max-w-3xl space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">ชื่อ-นามสกุล / ตำแหน่ง</label>
                                <input type="text" required value={newUserForm.name} onChange={(e) => setNewUserForm({...newUserForm, name: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-sky-500 outline-none" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">เลขประจำตัว 13 หลัก (ถ้ามี)</label>
                                <input type="text" maxLength="13" value={newUserForm.taxId} onChange={(e) => setNewUserForm({...newUserForm, taxId: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-sky-500 outline-none" placeholder="ไม่ต้องกรอกก็ได้ถ้าเป็นแอดมิน" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">ชื่อผู้ใช้งาน (Username)</label>
                                <input type="text" required value={newUserForm.username} onChange={(e) => setNewUserForm({...newUserForm, username: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-sky-500 outline-none" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน (Password)</label>
                                <input type="password" required value={newUserForm.password} onChange={(e) => setNewUserForm({...newUserForm, password: e.target.value})} className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-sky-500 outline-none" />
                              </div>
                              <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-slate-700 mb-1">สิทธิ์การใช้งาน</label>
                                <select value={newUserForm.role} onChange={(e) => setNewUserForm({...newUserForm, role: e.target.value})} className="w-full md:w-1/2 px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-sky-500 outline-none">
                                  <option value="admin">เจ้าหน้าที่ (Admin)</option>
                                  <option value="donor">ผู้บริจาค (Donor)</option>
                                </select>
                              </div>
                            </div>
                            <div className="pt-2">
                              <button type="submit" className="bg-emerald-600 text-white px-6 py-2 rounded hover:bg-emerald-700 transition shadow-sm">บันทึกผู้ใช้งาน</button>
                            </div>
                          </form>
                        </div>
                      )}

                      <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm whitespace-nowrap">
                          <thead className="bg-[#b3d4fc] text-slate-800 border-b border-slate-300">
                            <tr>
                              <th className="px-4 py-3 border-r border-slate-300">ชื่อ-นามสกุล</th>
                              <th className="px-4 py-3 border-r border-slate-300">ชื่อผู้ใช้งาน</th>
                              <th className="px-4 py-3 border-r border-slate-300">บทบาท</th>
                              <th className="px-4 py-3 border-r border-slate-300 text-center">เลขประจำตัว 13 หลัก</th>
                              <th className="px-4 py-3 text-center">จัดการ</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-200">
                            {users.map((u) => (
                              <tr key={u.id} className="hover:bg-slate-50">
                                <td className="px-4 py-3 border-r border-slate-200 font-medium text-slate-800">{u.name}</td>
                                <td className="px-4 py-3 border-r border-slate-200 text-slate-500">{u.username}</td>
                                <td className="px-4 py-3 border-r border-slate-200">
                                  {u.role === 'admin' 
                                    ? <span className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-medium">เจ้าหน้าที่ (Admin)</span>
                                    : <span className="bg-sky-100 text-sky-700 px-2 py-1 rounded text-xs font-medium">ผู้บริจาค (Donor)</span>
                                  }
                                </td>
                                <td className="px-4 py-3 border-r border-slate-200 text-center font-mono text-slate-600">{u.taxId || '-'}</td>
                                <td className="px-4 py-3 text-center">
                                  <button onClick={() => showNotification(`ระงับการใช้งาน ${u.name} แล้ว`, 'error')} className="text-red-500 hover:text-red-700 bg-red-50 px-2 py-1 rounded text-xs border border-red-200">ระงับผู้ใช้</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              </main>
            </div>

            {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-10 md:hidden" onClick={() => setIsSidebarOpen(false)}></div>}
          </div>
        );
      }

      // แสดงผลแอปพลิเคชัน
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    };
    
    // เริ่มทำงานระบบ
    startApp();
  </script>
</body>
</html>
